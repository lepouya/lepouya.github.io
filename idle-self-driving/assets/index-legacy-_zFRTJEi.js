!function(){function e(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}System.register(["./react-legacy-D9XK6Lhc.js","./ionic-legacy-pOgxQMfw.js","./ionicons-legacy-B9JX93zP.js"],(function(t,i){"use strict";var n,s,r,a,o,h,c,l,d,g,u,p,f,m,x,k,w,v,y,j,b,T,S,M,I,$,A,P,C,D,E,R,z,O,L,N,U,F,B,W,q,H,G,J,Y,_,Z;return{setters:[e=>{n=e.r,s=e.j,r=e.c,a=e.e,o=e.f},e=>{h=e.u,c=e.f,l=e.S,d=e.I,g=e.j,u=e.k,p=e.m,f=e.n,m=e.o,x=e.q,k=e.r,w=e.s,v=e.t,y=e.v,j=e.w,b=e.x,T=e.y,S=e.z,M=e.A,I=e.B,$=e.C,A=e.D,P=e.E,C=e.F,D=e.G,E=e.J,R=e.K,z=e.L,O=e.M,L=e.N,N=e.O,U=e.P,F=e.Q,B=e.R,W=e.T,q=e.U},e=>{H=e.p,G=e.r,J=e.I,Y=e.b,_=e.a,Z=e.c}],execute:function(){var t=document.createElement("style");function i(e=0,t=0,i=1){return isNaN(e)||e<t?t:e>i?i:e}t.textContent=".ion-page{max-width:min(80rem,100%);margin:auto}ion-popover{--backdrop-opacity: .75;--width: min(70rem, 90%)}\n/*$vite$:1*/",document.head.appendChild(t);class Q extends Error{}class X extends Error{}class K{constructor(t,i){e(this,"canvas",void 0),e(this,"options",void 0),this.canvas=t,this.options=i}get dataURL(){return this.canvas.toDataURL(this.options.format,this.options.quality)}get blob(){return new Promise(((e,t)=>this.canvas.toBlob((i=>i?e(i):t(new X)),this.options.format,this.options.quality)))}getPixels(e,t,i,n){const s=this.canvas.width,r=this.canvas.height,a=se(e,0,s-1),o=se(t,0,r-1),h=se(i,1,s-a),c=se(n,1,r-o),l=this.canvas?.getContext("2d",{alpha:!1})?.getImageData(a,o,h,c);if(!l)throw new X;return{buffer:new Uint32Array(l.data.buffer),startX:a-e,startY:o-t,width:h,height:c}}}async function V(e,t){const i=Object.assign({},ee,t),n=[...e||[],...i?.sources||[]],s=await Promise.all(n.map((e=>function(e,t){return new Promise(((i,n)=>{const s="string"==typeof e?{src:e}:e;s.src=(s.src||"").trim(),s.src&&"transparent"!==s.src?s.src.startsWith("plain:")?s.src=ie.replace("{color}",encodeURIComponent(s.src.slice(6).trim())).replace("{width}",t?.width?.toString()||"100%").replace("{height}",t?.height?.toString()||"100%"):s.src.startsWith("<svg")&&(s.src.includes("xmlns=")||(s.src=s.src.replace("<svg",'<svg xmlns="http://www.w3.org/2000/svg"')),s.src="data:image/svg+xml;utf8,"+encodeURIComponent(s.src.replace("{width}",t?.width?.toString()||"100%").replace("{height}",t?.height?.toString()||"100%"))):s.src=te;const r=new Image;r.onerror=()=>n(new Q),r.onload=()=>i([r,s]),r.crossOrigin="anonymous",r.src=s.src}))}(e,i))));let r=i.reuse instanceof HTMLCanvasElement?i.reuse:i.reuse?.canvas;r||(r=window.document.createElement("canvas")),r.width=i.width||Math.max(...s.map((([e])=>e.width))),r.height=i.height||Math.max(...s.map((([e])=>e.height))),r.className=[...Array.isArray(i.className)?i.className:[i.className],"composed-image"].join(" "),i.style&&Object.assign(r.style,i.style);const a=r.getContext("2d");i.clear&&a.clearRect(0,0,r.width,r.height);for(let[o,h]of s){a.save();let e=ne(h.crop,0,"x")||0,t=ne(h.crop,1,"y")||0,i=ne(h.crop,2,"w")||o.width,n=ne(h.crop,3,"h")||o.height,s=ne(h.position,0,"x")||0,r=ne(h.position,1,"y")||0,c=(ne(h.stretch,0,"sx")||1)*i,l=(ne(h.stretch,1,"sy")||1)*n,d=(ne(h.rotate,2,"a")||0)*(Math.PI/180),g="number"==typeof h.rotate?void 0:h.rotate,u=(ne(g,0,"x")??.5)*c+s,p=(ne(g,1,"y")??.5)*l+r,f=ne(h.scale,2,"sx")??1,m=ne(h.scale,3,"sy")??1,x="number"==typeof h.scale?void 0:h.scale,k=(ne(x,0,"x")??.5)*c+s,w=(ne(x,1,"y")??.5)*l+r;a.globalAlpha=h.opacity??1,a.globalCompositeOperation=h.composition??"source-over",a.imageSmoothingEnabled=!1!==h.smoothing&&"disabled"!==h.smoothing,a.imageSmoothingQuality="medium"===h.smoothing||"high"===h.smoothing?h.smoothing:"low",Array.isArray(h.filter)?a.filter=h.filter.join(" "):h.filter&&(a.filter=h.filter),a.filter||(a.filter="none"),a.resetTransform(),0!==d&&(a.translate(u,p),a.rotate(d),a.translate(-u,-p)),1===f&&1===m||(a.translate(k,w),a.scale(f,m),a.translate(-k,-w)),a.imageSmoothingEnabled||(e=~~e,t=~~t,i=~~i,n=~~n,s=~~s,r=~~r,c=~~c,l=~~l),a.drawImage(o,e,t,i,n,s,r,c,l),a.restore()}return new K(r,i)}const ee={format:"image/png",quality:.92},te="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",ie='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1" preserveAspectRatio="none"     width="{width}" height="{height}">  <rect x="0" y="0" width="1" height="1" fill="{color}" /></svg>';function ne(e,...t){let i;if(e&&"number"!=typeof e){if(Array.isArray(e)){for(let n of t)if("string"==typeof n&&(n=parseInt(n)),"number"==typeof n&&isFinite(n)){const t=e[n];if(null!=t&&"number"==typeof t){i=t;break}}}else if("object"==typeof e)for(let n of t)if("string"==typeof n||"number"==typeof n){const t=e[n];if(null!=t&&"number"==typeof t){i=t;break}}}else i=e??void 0;for(let n of t)n&&"object"==typeof n&&(null!=n.def&&null==i&&(i=n.def),null!=n.min&&null!=i&&(i=Math.max(i,n.min)),null!=n.max&&null!=i&&(i=Math.min(i,n.max)));return i}function se(e=0,t=0,i=1){return isNaN(e)||e<t?~~t:e>i?~~i:~~e}function re(e){const t={};function i(){return"function"==typeof e?e():e}function s(){return Date.now().toString(36)+Math.random().toString(36).slice(1)}function r(e,i){const n=i||s();return t[n]=e,n}function a(e){delete t[e]}return{useHook:function(){const[e,t]=n.useState(s),[o,l]=n.useState((()=>({ref:i()})));return n.useEffect((()=>{const i=r(l,e);return t(i),()=>{a(e),a(i)}}),[e]),h((()=>{const i=r(l,e);t(i)}),[e]),c((()=>{a(e)}),[e]),o.ref},signal:function(){const e={ref:i()};Object.values(t).forEach((t=>t(e)))},register:r,unregister:a,getRegistry:function(){return t},get:i}}function ae(e){if(ae.skipEncoding||!e)return e;const t=e.startsWith(".."),i=(t?e:Math.random().toString(36)).substring(2,10);return(t?"":".."+i)+(t?e.slice(10):e).split("").map((e=>e.charCodeAt(0))).map(((e,t)=>String.fromCharCode(e^i.charCodeAt(t%8)))).join("")}function oe(e,t=!1){const i=function(e,t){const i=[];return JSON.stringify(e,(function(e,t){return e&&e.startsWith("_")?void 0:!t||"object"!=typeof t||Array.isArray(t)?t:t instanceof Date?t.toJSON():0===Object.keys(t).length||i.includes(t)?void 0:(i.push(t),t)}),t)}(e,t?2:void 0);return t?i:window.btoa(ae(encodeURIComponent(i)))}function he(e){if(!e||"string"!=typeof e)return e??void 0;try{const t=JSON.parse(decodeURIComponent(ae(window.atob(e))));if(t)return t}catch{}try{const t=JSON.parse(e);if(t)return t}catch{}return e}ae.skipEncoding=!1;const ce={db:void 0};function le(){return le.initialize(),ce.db}function de(e,t){de.register(e,t)}le.initialize=async function(){return ce.db||(ce.db=new l,ce.db=await ce.db.create()),ce.db},le.write=async function(e,t,i=!1){const n=oe(t,i),s=await le.initialize();return await(s?.set(e,n))},le.read=async function(e){const t=await le.initialize();return he(await(t?.get(e)))},le.clear=async function(){const e=await le.initialize();await(e?.clear())},de.register=function(e,t){var i;e=e.toLowerCase().replace(/\W/g,""),ue[i=e]??(ue[i]=[]),ue[e].includes(t)||ue[e].push(t)},de.addEventListeners=function(){document.addEventListener("keydown",fe),document.addEventListener("keyup",me),xe()},de.removeEventListeners=function(){document.removeEventListener("keydown",fe),document.removeEventListener("keyup",me),xe()},de.test=function(e){return pe[e.toLowerCase().replace(/\W/g,"")]??!1},de.some=function(...e){return e.some(de.test)},de.all=function(...e){return e.every(de.test)};const ge=["TEXTAREA","INPUT"],ue={},pe={};function fe(e){if(ke(e.target))return;const t=e.key.toLowerCase().replace(/\W/g,"");pe[t]=!0;const i=ue[t];i&&i.length>0&&i.forEach((t=>{t(e)&&(e.preventDefault(),e.stopPropagation())}))}function me(e){if(ke(e.target))return;const t=e.key.toLowerCase().replace(/\W/g,"");pe[t]=!1}function xe(){Object.keys(pe).forEach((e=>pe[e]=!1))}function ke(e){try{return e&&ge.includes(e.tagName.toUpperCase())}catch(t){return!1}}class we{constructor(e){this.config=e,this.validate(),this.regularize()}static init(e,t,i){if(!e)throw new Error("Invalid input count");if(!t)throw new Error("Invalid output count");i||(i=[]);const n=[];for(let s=0;s<i.length+1;s++){const r=0===s?e:i[s-1],a=s===i.length?t:i[s],o=[];for(let e=0;e<a;e++){const e=[];for(let t=0;t<r+1;t++)e.push(0);o.push(e)}n.push(o)}return new we({input:e,output:t,hidden:i,weights:n})}validate(){const{input:e,hidden:t,output:i,weights:n}=this.config;if(e<1)throw new Error("Invalid input count");if(t.length<0)throw new Error("Invalid hidden layer count");if(i<1)throw new Error("Invalid output count");if(n.length!==t.length+1)throw new Error("Invalid weight count");for(let s=0;s<n.length;s++){const r=0===s?e:t[s-1],a=s===t.length?i:t[s];if(n[s].length!==a)throw new Error(`Invalid row count for weights layer ${s}`);for(let e=0;e<n[s].length;e++)if(n[s][e].length!==r+1)throw new Error(`Invalid col count for weights layer ${s} neuron ${e}`)}}regularize(){const e=this.config.weights;for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)for(let s=0;s<e[t][n].length;s++)e[t][n][s]=i(e[t][n][s],-2,2)}eval(e){const t=this.config.weights;let i=e;for(let n=0;n<t.length;n++){let e=[];for(let s=0;s<t[n].length;s++){let r=t[n][s][i.length-1];for(let e=0;e<i.length-1;e++)r+=i[e]*t[n][s][e];e.push(this.activation(r))}i=e}return i}activation(e){return e<-1?-1:e>1?1:e}randomStep(e){return new we({...this.config,weights:this.config.weights.map((t=>t.map((t=>t.map((t=>function(e=0,t=1){const i=1-Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*n)*t+e}(t,e)))))))})}}class ve{constructor(t,n="",s=.5,r=!0){if(e(this,"renderImage",void 0),e(this,"sensorImage",void 0),e(this,"width",je.singleton.carWidth),e(this,"height",je.singleton.carHeight),e(this,"track",null),e(this,"position",{x:0,y:0}),e(this,"angle",0),e(this,"speed",0),e(this,"steering",0),e(this,"acceleration",0),e(this,"odometer",0),e(this,"laps",0),e(this,"inCrossing",!1),e(this,"totalTicks",0),e(this,"startTime",0),e(this,"endTime",0),e(this,"collided",!1),e(this,"pastTracking",[]),e(this,"sensorsReady",!0),e(this,"sensorReadingTime",0),e(this,"sensorReadings",[]),e(this,"visualizeSensors",!1),e(this,"net",null),this.name=t,this.color=n,this.fudgeFactor=s,!n){const e=[32,64,128].map((e=>i(~~(Math.random()*e*2),0,255)));this.color="#"+e.map((e=>e.toString(16).padStart(2,"0"))).join("")}t&&r&&(ve.registry.get()[t]=this)}get mask(){return[`<svg\n        width="${this.width}px"\n        height="${this.height}px"\n        viewBox="0 0 ${this.width} ${this.height}"\n      >`,`<rect\n        width="${this.width}"\n        height="${this.height}"\n        rx="${this.width/4}"\n        ry="${this.height/4}"\n        fill="${Te.color.vehicle}"\n        shape-rendering="crispEdges"\n      />`,"</svg>"].join("")}get image(){return[`<svg\n        width="${this.width}px"\n        height="${this.height}px"\n        viewBox="0 0 ${this.width} ${this.height}"\n      >`,`<rect\n        width="${this.width}"\n        height="${this.height}"\n        rx="${this.width/4}"\n        ry="${this.height/4}"\n        fill="${this.laps>=3?"green":this.collided?"red":this.color}"\n      />`,[[0,0],[3*this.width/4,0],[3*this.width/4,3*this.height/4],[0,3*this.height/4]].map((([e,t])=>`<rect\n            x="${e}"\n            y="${t}"\n            width="${this.width/4}"\n            height="${this.height/4}"\n            rx="${this.width/8}"\n            ry="${this.height/8}"\n            fill="black"\n          />`)),"</svg>"].join("")}get canvas(){return this.renderImage?.canvas}async fetchImageData(){return this.renderImage=await V([],{reuse:this.renderImage,clear:!0,sources:[{src:this.image,opacity:this.net?.666:1}],width:this.width,height:this.height}),this.renderImage}get score(){const e=Date.now(),t=this.odometer/Math.max(this.width,this.height),i=((this.endTime||e)-(this.startTime||e))/1e3;return{distance:t,time:i,laps:this.laps,success:!this.collided&&this.laps>=3&&this.startTime>0,score:this.startTime>0?Math.max(0,t-i)+(this.laps+1)**2*10:0}}placeOnTrack(e){this.track=e,this.position.x=e.startingPoint.x,this.position.y=e.startingPoint.y,this.angle=e.startingAngle,this.speed=0,this.steering=0,this.acceleration=0,this.position.x-=e.startingDirection.x*this.width/2,this.position.y-=e.startingDirection.y*this.height/2;const t=this.net?Math.random()*e.roadThickness-e.roadThickness/2:0;this.position.x+=t*this.fudgeFactor*e.startingDirection.y,this.position.y-=t*this.fudgeFactor*e.startingDirection.x,this.odometer=0,this.laps=0,this.inCrossing=!1,this.startTime=0,this.endTime=0,this.collided=!1,this.fetchImageData();const i=Math.max(this.width,this.height,this.track.roadThickness)+1;this.pastTracking=[{x:e.startingPoint.x-e.startingDirection.x*i,y:e.startingPoint.y-e.startingDirection.y*i}],this.sensorsReady=!0,this.sensorReadingTime=Date.now()}endRun(e=!0){this.endTime=Date.now(),this.startTime||(this.startTime=this.endTime),this.inCrossing=!1,this.collided=e,this.fetchImageData();const t=je.singleton;this.track&&this.net&&this.score.score>(t.sotaScore[this.track.name]?.score??0)&&(t.sotaNet=this.net.config,t.sotaScore={[this.track.name]:this.score})}render(e,t=!1){if(this.canvas){if(e.save(),e.resetTransform(),e.translate(~~this.position.x,~~this.position.y),e.rotate(this.angle),(this.visualizeSensors||"Manual"===this.name)&&Te.registry.get().forEach(((t,i)=>t.render(e,this.sensorReadings[i]))),e.drawImage(this.canvas,~~(-this.width/2),~~(-this.height/2)),t){const t=Math.abs(Math.sin(Date.now()/200)+1);e.filter=`blur(${5*t}px) brightness(${100*t}%)`,e.drawImage(this.canvas,~~(-this.width/2),~~(-this.height/2))}e.restore()}}tick(e){if(this.collided||!this.track)return;if("Manual"===this.name)this.manualControl();else{const e=this.score;if(e.score<-10||this.totalTicks>3&&0===e.laps&&e.score<=e.time)return console.log(this.name,"doesn't seem to be going anywhere"),this.endRun();if(e.laps>=3)return this.endRun()}const t=je.singleton;if(this.totalTicks+=e,this.steering=i(this.steering,-1,1),this.steering=i(this.steering,-this.speed,this.speed),Math.abs(this.steering)>=.01&&(this.angle+=t.maxSteering*this.steering*e,this.steering-=t.friction*Math.sign(this.steering)*e,this.speed-=t.friction*this.speed*e),this.angle>Math.PI?this.angle-=2*Math.PI:this.angle<-Math.PI&&(this.angle+=2*Math.PI),this.acceleration=i(this.acceleration,-1,1),Math.abs(this.acceleration)>=.01?(this.speed+=t.maxAcceleration*this.acceleration*e,this.acceleration-=t.friction*Math.sign(this.acceleration)*e):this.speed-=t.friction*this.speed*e,this.speed=i(this.speed,0,t.maxSpeed),this.position.x+=Math.cos(this.angle)*this.speed*e,this.position.y+=Math.sin(this.angle)*this.speed*e,this.odometer+=this.speed*e,this.position.x<=0||this.position.x>=this.track.width||this.position.y<=0||this.position.y>=this.track.height)return console.log(this.name,"went out of bounds"),this.endRun();const n=Math.max(this.width,this.height,this.track.roadThickness),s=this.pastTracking.map((e=>Math.hypot(e.x-this.position.x,e.y-this.position.y)));if(0===s.length||s.every((e=>e>n)))this.pastTracking.unshift({x:this.position.x,y:this.position.y}),this.pastTracking.length>3&&this.pastTracking.pop();else if(s.length>1&&s.slice(1).some((e=>e<n)))return console.log(this.name,"went back on the track"),this.endRun();this.checkSensors()}async renderSensors(){return V([],{width:je.singleton.trackWidth,height:je.singleton.trackHeight,sources:[{src:this.track?.mask||"transparent",smoothing:!1},{src:this.mask,position:{x:this.position.x-this.width/2,y:this.position.y-this.height/2},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1},...Te.registry.get().map((e=>({src:e.mask,position:{x:this.position.x-e.range,y:this.position.y-e.range},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1})))]})}checkSensors(){if(this.track&&!this.collided&&(this.sensorsReady||!(Date.now()-this.sensorReadingTime<100)))return this.sensorsReady=!1,V([],{width:this.track.width,height:this.track.height,reuse:this.sensorImage,clear:!0,sources:[{src:this.track.mask,smoothing:!1},{src:this.mask,position:{x:this.position.x-this.width/2,y:this.position.y-this.height/2},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1}]}).then((e=>{this.sensorImage=e;if(this.checkCollision(e))return this.endRun();if(this.sensorReadings=Te.readAll(e,this.position.x,this.position.y,this.angle),this.net){const e=this.net.eval([...this.sensorReadings,this.acceleration,this.steering,this.speed/je.singleton.maxSpeed,this.angle/Math.PI]);this.acceleration=e[0],this.steering=e[1]}})).catch((e=>{console.error("Error reading sensors",this.name,e)})).finally((()=>{this.sensorsReady=!0,this.sensorReadingTime=Date.now()}))}checkCollision(e){const t=1+~~Math.max(this.width/2,this.height/2),i=e.getPixels(this.position.x-t,this.position.y-t,2*t,2*t).buffer,n=i.some((e=>Te.check(e,Te.vehicle,Te.lapLine))),s=i.some((e=>Te.check(e,Te.vehicle,Te.offTrack))),r=this.angle,a=this.track.startingAngle;let o=Math.abs((r<0?r+2*Math.PI:r)-(a<0?a+2*Math.PI:a));if(o>Math.PI&&(o=2*Math.PI-o),n&&!this.inCrossing){if(this.inCrossing=!0,o>Math.PI/2)return console.log(this.name,"crossed the lap line the wrong way"),!0;if(this.startTime){if(this.odometer<this.width+this.height)return console.log(this.name,"didn't complete a full lap"),!0;this.laps++,console.log(this.name,"has completeted lap",this.laps,this.score.score)}else this.startTime=Date.now()}else if(!n&&this.inCrossing&&(this.inCrossing=!1,o>Math.PI/2))return console.log(this.name,"turned around on the lap line"),!0;return!!s&&(console.log(this.name,"went off track"),!0)}manualControl(){de.some("ArrowDown","S")?this.acceleration=i(this.acceleration-.1,-1,-.1):de.some("ArrowUp","W")?this.acceleration=i(this.acceleration+.1,.1,1):this.acceleration=0,de.some("ArrowLeft","A")?this.steering=i(this.steering-.1,-1,-.1):de.some("ArrowRight","D")?this.steering=i(this.steering+.1,.1,1):this.steering=0}}(e=>{async function t(t,i=!1){const s=je.singleton,r=e.registry.get();if(!s.manualControl||r.Manual&&!(r.Manual?.collided??1)&&(r.Manual?.track?.name??"")===t.name)!s.manualControl&&r.Manual&&delete r.Manual;else{new e("Manual","#33eeee").placeOnTrack(t)}const a=Object.values(r).filter((e=>"Manual"!==e.name&&e.net));if(!i&&a.some((e=>!e.collided&&e.track===t)))return;a.forEach((e=>e.endRun())),a.sort(((e,t)=>t.score.score-e.score.score));const o=new we(s.sotaNet),h=s.sotaScore[t.name],c=a[0]?.net??o,l=a[0]?.score??h,d=Math.floor(Math.random()*a.length),g=a[d]?.net??c,u=a[d]?.score??l;for(let p=0;p<s.numSimulations.globalBest;p++){new e(`AI.globalBest.${p}`).net=o.randomStep(0===p?0:n(h))}for(let p=0;p<s.numSimulations.trackBest;p++){new e(`AI.trackBest.${p}`).net=c.randomStep(0===p&&l?.score!==h?.score?0:n(l))}for(let p=0;p<s.numSimulations.trackRandom;p++){new e(`AI.trackRandom.${p}`).net=g.randomStep(n(u))}s.numIterations++,console.log("Starting iteration",s.numIterations),Object.values(r).forEach((e=>{e.track||e.placeOnTrack(t)})),await Promise.all(Object.values(r).map((e=>e.fetchImageData()))),je.save(),e.registry.signal()}function n(e){return e&&e.score&&e.distance&&e.time?i(Math.sqrt(10/e.score),.1,1):1}e.registry=re({}),e.renderAll=function(t){Object.values(e.registry.get()).sort(((e,t)=>t.score.score-e.score.score)).forEach(((e,i)=>e.render(t,0===i)))},e.tickAll=function(i){if(Object.values(e.registry.get()).forEach((e=>e.tick(i))),je.singleton.autoAdvance){const i=Object.values(e.registry.get());if(i.every((e=>e.collided||"Manual"===e.name))){const e=i[0]?.track;e&&t(e,!1)}}},e.nextGeneration=t})(ve||(ve={}));const ye=ve;class je{constructor(t){e(this,"ticksPerSec",100),e(this,"rendersPerSec",30),e(this,"saveFrequencySecs",60),e(this,"minUpdateSecs",.01),e(this,"maxUpdateSecs",.25),e(this,"maxTickSecs",.1),e(this,"globalTimeDilation",1),e(this,"globalPaused",!1),e(this,"lastReset",Date.now()),e(this,"lastSaved",0),e(this,"lastLoaded",Date.now()),e(this,"lastRender",0),e(this,"lastTick",void 0),e(this,"onTickComplete",void 0),e(this,"execution",{}),e(this,"helpDismissed",void 0),e(this,"trackWidth",800),e(this,"trackHeight",600),e(this,"currentTrack","Basic"),e(this,"autoAdvance",!1),e(this,"carWidth",20),e(this,"carHeight",15),e(this,"friction",.1),e(this,"maxSpeed",100),e(this,"maxAcceleration",25),e(this,"maxSteering",Math.PI/2),e(this,"manualControl",!1),e(this,"renderSensors",!1),e(this,"sensors",[{range:100,angle:0},{range:100,angle:Math.PI/6},{range:100,angle:-Math.PI/6},{range:100,angle:Math.PI/3},{range:100,angle:-Math.PI/3}]),e(this,"numIterations",0),e(this,"numSimulations",{globalBest:4,trackBest:4,trackRandom:2}),e(this,"sotaScore",{}),e(this,"sotaNet",we.init(this.sensors.length+4,2,[]).config),this.load(t),je.singleton=this}isDebug(){return window.location.search.toLowerCase().includes("debug")}set(e){let t;for(t in e)null!=e[t]&&null!=e[t]&&("object"==typeof this[t]&&"object"==typeof e[t]?Object.assign(this[t],e[t]):this[t]=e[t]);return je.registry.signal(),this}load(e){return e?"string"==typeof e?this.load(JSON.parse(e)):(this.set(e),this.lastLoaded=Date.now(),this):this}save(){return this.lastSaved=Date.now(),this}tick(e=Date.now(),t="unknown",n,s){let r=i((e-(this.lastTick??e))/1e3,0,this.maxUpdateSecs);if(r<this.minUpdateSecs&&null!=this.lastTick)return[];this.lastTick=e;const a=e-1e3*r,o=1/this.globalTimeDilation,h=[r,1];for(;r>0;){const e=i(r,this.minUpdateSecs,this.maxTickSecs);r-=e,"tick"===t&&ye.tickAll(this.globalPaused?0:e*o)}return this.execution[t]={lastTick:e,lastDelta:(e-a)/1e3,lastResult:Object.values({}).flat().filter(((e,t,i)=>i.indexOf(e)===t)),tps:.8*(this.execution[t]?.tps||0)+h[1]/h[0]*.2,fps:this.execution[t]?.fps||0},this.onTickComplete&&this.onTickComplete((e-a)/1e3,t),n&&this.lastTick-this.lastSaved>=1e3*this.saveFrequencySecs&&this.lastTick-this.lastLoaded>=1e3*this.saveFrequencySecs&&(this.lastSaved=this.lastTick,n(this)),s&&this.lastTick-this.lastRender>=1e3/this.rendersPerSec&&(this.execution[t].fps=.8*(this.execution[t].fps||0)+1e3/(this.lastTick-this.lastRender)*.2,this.lastRender=this.lastTick,s(this)),this.execution[t].lastResult}}function be(){return je.registry.useHook()}e(je,"singleton",new je),(e=>{async function t(){e.singleton.tick(void 0,"save");const t=await le.write("Settings",e.singleton.save());return e.registry.signal(),t}function i(i,n){return e.singleton.tick(i,n,t,e.registry.signal)}e.registry=re((()=>e.singleton)),e.save=t,e.load=async function(){return e.singleton.load(await le.read("Settings")),e.singleton.tick(void 0,"load"),e.registry.signal(),e.singleton},e.reset=function(t){return e.singleton=new e(t),e.registry.signal(),e.singleton},e.tick=i;const n=[];function s(){n.forEach((e=>clearInterval(e))),n.length=0}e.addTickTimer=function(){s();const t=setInterval((()=>i(void 0,"tick")),1e3/e.singleton.ticksPerSec);n.push(t)},e.removeTickTimer=s})(je||(je={}));class Te{constructor(t,i){e(this,"renderImage",void 0),e(this,"path",void 0),this.range=t,this.angle=i;const n=t*Math.cos(i),s=t*Math.sin(i);this.path=`M ${~~t} ${~~t} l ${~~n} ${~~s}`}get maskColor(){return Te.radar}get mask(){return[`<svg\n        width="${2*this.range}px"\n        height="${2*this.range}px"\n        viewBox="0 0 ${2*this.range} ${2*this.range}"\n      >`,`<path\n        d="${this.path}"\n        stroke="${Te.color.radar}"\n        stroke-width="2px"\n        stroke-linecap="butt"\n        fill="none"\n        shape-rendering="crispEdges"\n      />`,"</svg>"].join("")}get image(){return[`<svg\n        width="${2*this.range}px"\n        height="${2*this.range}px"\n        viewBox="0 0 ${2*this.range} ${2*this.range}"\n      >`,`<path\n        d="${this.path}"\n        stroke="green"\n        stroke-width="2px"\n        stroke-linecap="round"\n        fill="none"\n      />`,"</svg>"].join("")}get canvas(){return this.renderImage?.canvas}async fetchImageData(){return this.renderImage=await V([this.image],{reuse:this.renderImage,clear:!0,width:2*this.range,height:2*this.range}),this.renderImage}render(e,t=1){if(!this.canvas)return;const i=~~this.range,n=~~(this.range*t);e.globalCompositeOperation="lighter",e.drawImage(this.canvas,-i,-i,2*i,2*i),e.globalCompositeOperation="source-over",e.drawImage(this.canvas,-n,-n,2*n,2*n)}read(e,t,n,s,r,a){const o=Math.cos(this.angle+a),h=Math.sin(this.angle+a);let c=0;for(let l=0;l<this.range;l++){const a=i(~~(r+l*h),0,n-1),d=i(~~(s+l*o),0,t-1);if(Te.check(e[a*t+d],Te.offTrack))break;c=l}return i(c/this.range,0,1)}}(e=>{function t(e){return"#"+e.toString(16).padStart(6,"0")}e.available=0,e.offTrack=8388608,e.lapLine=32768,e.vehicle=8355711,e.radar=128,e.color={available:t(e.available),offTrack:t(e.offTrack),lapLine:t(e.lapLine),vehicle:t(e.vehicle),radar:t(e.radar)},e.check=function(e,...t){const i=(16711680&(n=t.reduce(((e,t)=>e|t),0)))>>16|(255&n)<<16|65280&n;var n;return(e&i)===i},e.registry=re([]),e.loadAll=async function(){const t=je.singleton.sensors.map((({range:t,angle:i})=>new e(t,i)));t.forEach((t=>e.registry.get().push(t))),await Promise.all(t.map((e=>e.fetchImageData()))),e.registry.signal()},e.readAll=function(t,i,n,s){const r=~~Math.max(...e.registry.get().map((e=>e.range))),{buffer:a,startX:o,startY:h,width:c,height:l}=t.getPixels(~~i-r,~~n-r,2*r,2*r);return e.registry.get().map((e=>e.read(a,c,l,r-o,r-h,s)))}})(Te||(Te={}));class Se{constructor(t){e(this,"renderImage",void 0),e(this,"width",je.singleton.trackWidth),e(this,"height",je.singleton.trackHeight),this.name=t}get startingAngle(){return Math.atan2(this.startingDirection.y,this.startingDirection.x)}get mask(){return[`<svg\n        width="${this.width}px"\n        height="${this.height}px"\n        viewBox="0 0 ${this.width} ${this.height}"\n      >`,`<rect\n        width="${this.width}"\n        height="${this.height}"\n        fill="${Te.color.offTrack}"\n        shape-rendering="crispEdges"\n      />`,this.path.map((e=>`<path\n            d="${e}"\n            stroke="${Te.color.available}"\n            stroke-width="${this.roadThickness}px"\n            stroke-linecap="round"\n            stroke-linejoin="round"\n            fill="none"\n            shape-rendering="crispEdges"\n          />`)),`<path\n        d="M ${this.startingPoint.x} ${this.startingPoint.y} l ${Math.sign(this.startingDirection.x)*this.laneMarkingThickness} ${Math.sign(this.startingDirection.y)*this.laneMarkingThickness}"\n        stroke="${Te.color.lapLine}"\n        stroke-width="${this.roadThickness}px"\n        stroke-linecap="butt"\n        fill="none"\n      />`,"</svg>"].join("")}get image(){return[`<svg\n        width="${this.width}px"\n        height="${this.height}px"\n        viewBox="0 0 ${this.width} ${this.height}"\n      >`,`<rect\n        width="${this.width}"\n        height="${this.height}"\n        fill="lightgreen"\n      />`,this.path.map((e=>`<path\n            d="${e}"\n            stroke="salmon"\n            stroke-width="${this.roadThickness+2*this.laneMarkingThickness}px"\n            stroke-linecap="round"\n            stroke-linejoin="round"\n            fill="none"\n          />`)),this.path.map((e=>`<path\n            d="${e}"\n            stroke="lightgray"\n            stroke-width="${this.roadThickness}px"\n            stroke-linecap="round"\n            stroke-linejoin="round"\n            fill="none"\n          />`)),this.path.map((e=>`<path\n            d="${e}"\n            stroke="yellow"\n            stroke-width="${this.laneMarkingThickness}px"\n            stroke-dasharray="\n              ${3*this.laneMarkingThickness},\n              ${5*this.laneMarkingThickness}"\n            stroke-dashoffset="${this.laneMarkingThickness}"\n            stroke-linecap="round"\n            stroke-linejoin="round"\n            fill="none"\n          />`)),`<path\n        d="M ${this.startingPoint.x} ${this.startingPoint.y} l ${Math.sign(this.startingDirection.x)*this.laneMarkingThickness} ${Math.sign(this.startingDirection.y)*this.laneMarkingThickness}"\n        stroke="white"\n        stroke-width="${this.roadThickness}px"\n        stroke-linecap="butt"\n        fill="none"\n      />`,"</svg>"].join("")}get canvas(){return this.renderImage?.canvas}async fetchImageData(){return this.renderImage=await V([this.image],{reuse:this.renderImage,clear:!0,width:this.width,height:this.height}),this.renderImage}render(e){this.canvas&&e.drawImage(this.canvas,0,0)}}var Me;(Me=Se||(Se={})).registry=re({}),Me.loadAll=async function(){const e=[new $e("Basic"),new Ae("Advanced"),new Pe("Oval"),new Ce("Curvy")];e.forEach((e=>{Me.registry.get()[e.name]=e})),await Promise.all(e.map((e=>e.fetchImageData()))),Me.registry.signal()};const Ie=Se;class $e extends Se{get path(){return["M 730 70 h -360 v 200 h -300 v 260 h 400 l 260 -260 v -160 Z"]}get roadThickness(){return 80}get laneMarkingThickness(){return 3}get startingPoint(){return{x:150,y:530}}get startingDirection(){return{x:1,y:0}}}class Ae extends Se{get path(){return["M 750 50 h -300 l -200 100 l -100 -70 h -100 v 450 h 300 v -150 h 50 v -200 h 100 v 380 h 150 Z"]}get roadThickness(){return 60}get laneMarkingThickness(){return 3}get startingPoint(){return{x:600,y:50}}get startingDirection(){return{x:1,y:0}}}class Pe extends Se{get path(){return["M 400 100 Q 100 100 100 300 T 400 500 T 700 300 T 400 100 Z"]}get roadThickness(){return 100}get laneMarkingThickness(){return 3}get startingPoint(){return{x:400,y:100}}get startingDirection(){return{x:-1,y:0}}}class Ce extends Se{get path(){return["M 100 300 c 0 100 50 200 150 200 s 50 -150 150 -150 s 50 150 150 150 s 150 -100 150 -200 s 0 -100 -100 -100 s -100 0 -100 -100 s 0 0 -100 0 s 0 0 -100 0 s 0 -50 -100 -50 s -100 150 -100 250 Z"]}get roadThickness(){return 70}get laneMarkingThickness(){return 3}get startingPoint(){return{x:400,y:100}}get startingDirection(){return{x:-1,y:0}}}const De=d,Ee=g,Re=u;function ze(){const e=be(),t=n.useRef(null),[i,r]=n.useState(),[a,o]=n.useState();return n.useEffect((()=>{(async()=>{const e=new Oe("Demo Track"),t=new ye("","#33eeee",0,!1);t.visualizeSensors=!0,await Promise.all([e.fetchImageData(),t.fetchImageData()]),t.placeOnTrack(e),t.position={x:100,y:100},t.tick(0),await t.renderSensors(),r(e),o(t)})()}),[r,o]),n.useEffect((()=>{if(!(t.current&&a&&a.canvas&&i&&i.canvas))return;const n=e.lastRender/1e3%8*45*(Math.PI/180);a.position={x:100+50*Math.cos(n),y:100+40*Math.sin(n)},a.angle=n+Math.PI/2,a.tick(0);const s=t.current.getContext("2d",{alpha:!1});i.render(s),a.render(s)}),[e.lastRender,t.current,a,i]),s.jsxs(p,{fixed:!0,children:[s.jsx(f,{children:s.jsx(m,{children:s.jsx("h1",{children:"About: Idle Self Driving"})})}),s.jsx(f,{children:s.jsx(m,{children:s.jsx("p",{children:"This is a simple demonstration of self-driving cars receiving sensory information from their surroundings and controlling their acceleration and steering using a simple neural network."})})}),s.jsxs(f,{children:[s.jsx(m,{size:"4",children:s.jsx("canvas",{ref:t,width:`${i?.width||1}px`,height:`${i?.height||1}px`,style:{margin:"auto",display:"block"}})}),s.jsxs(m,{size:"8",children:[s.jsx("p",{children:"Each car has 5 sensor inputs in front of it. The reading values are between 0 and 1 indicating how far the car is from the edges of the track"}),s.jsx("p",{children:"The network outputs two values between -1 and 1. One for the acceleration of the car (negative means breaking), and the other for steering (negative for left, positive for right)."}),s.jsx("p",{children:"A simple simulation calculates the velocity and the angle of the car. Some basic friction is also calculated for speed and steering, but I didn't bother with drifting or skidding. At least not for now."})]})]}),s.jsx(f,{children:s.jsxs(m,{children:[s.jsx("p",{children:'The cars can "lose" if they hit the edges of the track. There are also some criteria for crossing the finish line in wrong direction or backtracking on the track. There is no collision between the cars, so you can think of this as being in separate tracks or ghosting.'}),s.jsx("p",{children:'A car "wins" if it successfully laps the track 3 times. The scoring is based on the distance travelled and the speed of the car. The faster a car finishes the laps the better it scores. And the further it gets before losing the better it scores.'}),s.jsx("p",{children:"At the beginning of each iteration, 10 new cars are generated based on the global best on the track and the winner of the last track. Some random choices are also made. The further we are in the training, the less random variations there are between cars"}),s.jsxs("p",{children:["The ",s.jsx(x,{icon:H})," button will start a new iteration, even if there are still cars racing in the current track. Use the ",s.jsx(x,{icon:G})," button to automatically advance to the next iteration after all cars have finished."]})]})}),s.jsx(f,{children:s.jsxs(m,{children:[s.jsx("p",{children:'You can also change the track the race is taking place on the right side panel. I recommend moving on to the "Advanced" track once you have trained a car that can lap around the "Basic" track. It might take a few more iterations before you have a car that can make the tight corners on the "Advanced" track.'}),s.jsx("p",{children:'There is also an "Oval" track that you can use for fine-tuning the speed of the track navigation, but be mindful that staying on it too long might cause your model to "forget" how to turn left. This is not a commentary on NASCAR™. I promise.'}),s.jsx("p",{children:'Finally, you can put all of the learnings to the test on the "Curvy" track to test both steering abilities and the speed choices of your model.'})]})}),s.jsx(f,{children:s.jsxs(m,{children:["Pro tips:",s.jsxs("ul",{children:[s.jsx("li",{children:'You can save / load / reset the state on the "Settings" tab below. Using import/export features lets you share your models'}),s.jsx("li",{children:"The ability to customize # of sensors, their angles, and ranges are there, but I haven't made the UI for it yet. You can still do it by mocking around in the saved settings, or just get the source code: the link is on top right. Coming later."}),s.jsx("li",{children:"Ability to change the # of layers and neurons in the net is also there, but doesn't have a UI either. You can use the same tricks above to play with it. Or to view your current SOTA."}),s.jsx("li",{children:'If you want your save files in plain text (json) instead of base64, add "?debug" to the end of the URL and you get a bunch of new feature'})]})]})})]})}class Oe extends Ie{constructor(...t){super(...t),e(this,"width",200),e(this,"height",200)}get path(){return["M 0 100 h 200"]}get roadThickness(){return 120}get laneMarkingThickness(){return 3}get startingPoint(){return{x:25,y:100}}get startingDirection(){return{x:1,y:0}}}const Le=J;function Ne({icon:e,src:t,...i}){const n=e||t||"";return n.startsWith("data:")?s.jsx(x,{icon:n,...i}):n.includes("/")||n.includes(".")?s.jsx(x,{src:n,...i}):Le[n]?s.jsx(x,{icon:Le[n],...i}):s.jsx(x,{icon:Y,...i})}function Ue(){const e=Ue.useTabs(),t=je.singleton,[i,o]=n.useState(!t.helpDismissed),h=window.location.search||"";return n.useEffect((()=>{t.set({helpDismissed:!i})}),[i,o]),s.jsx(k,{children:s.jsxs(Ee,{children:[s.jsxs(w,{children:[e.map((e=>s.jsx(r,{exact:!0,path:`/${e.path}`,children:s.jsxs(v,{children:[s.jsx(y,{children:s.jsxs(j,{children:[s.jsx(b,{slot:"start",children:e.title||e.path}),s.jsxs(T,{slot:"end",color:"success",children:["© 2025  ",s.jsx("a",{href:"https://github.com/lepouya",target:"_blank",style:{textDecoration:"none"},children:"@lepouya"})]}),s.jsx(T,{slot:"end",color:"light",children:s.jsx("a",{href:"https://github.com/lepouya/idle-self-driving",target:"_blank",style:{textDecoration:"none"},children:s.jsx("small",{children:"view source"})})})]})}),s.jsx(S,{id:"tab-page",children:e.content}),s.jsx(M,{trigger:i?"tab-page":void 0,isOpen:i,showBackdrop:!0,side:"start",alignment:"start",onDidDismiss:()=>o(!1),children:s.jsxs(S,{class:"ion-padding",children:[s.jsx(ze,{}),s.jsx(I,{onClick:()=>o(!1),children:"Close"})]})})]})},`tab-${e.path}`))),e.filter((e=>!!e.from)).map((e=>s.jsx(r,{exact:!0,path:e.from,children:s.jsx(a,{to:`/${e.path}${h}`})},`default-tab-${e.path}`)))]}),s.jsx($,{slot:"bottom",children:e.map((e=>(e.icon||e.label)&&s.jsxs(Re,{tab:e.path,href:`/${e.path}${h}`,children:[e.icon&&s.jsx(Ne,{"aria-hidden":"true",icon:e.icon}),e.label&&s.jsx(A,{children:e.label})]},`tab-button-${e.path}`)))})]})})}const Fe=re({});function Be(e,t){return null==e||null==e||"string"==typeof e?Be.word(e??void 0,t):e instanceof Date?Be.time(e.getTime(),t):"number"==typeof e?Be.number(e,t):""}function We(){const e=be(),t=n.useRef(null),i=Se.registry.useHook(),r=function(){const e=ve.registry.useHook();return Object.values(e)}(),a=i[e.currentTrack];n.useEffect((()=>{ye.nextGeneration(a,!1)}),[a]),n.useEffect((()=>{if(t.current){const i=t.current.getContext("2d",{alpha:!1});e.renderSensors?r[0]?.renderSensors().then((t=>{i.clearRect(0,0,e.trackWidth,e.trackHeight),i.resetTransform(),i.drawImage(t.canvas,0,0)})):(a.render(i),ye.renderAll(i))}}),[e.currentTrack,t.current,e.lastRender]);const o=Math.max(...r.map((e=>e.score.score)))||0,h=r.filter((e=>!e.collided)).length;return s.jsx(p,{children:s.jsxs(f,{children:[s.jsx(m,{size:"8",children:s.jsx("canvas",{ref:t,width:`${e.trackWidth}px`,height:`${e.trackHeight}px`})}),s.jsxs(m,{size:"4",children:[s.jsxs(P,{children:[s.jsxs(A,{children:["Iteration ",e.numIterations]}),s.jsx(I,{slot:"end",expand:"block",title:"Skip to next iteration",onClick:()=>ye.nextGeneration(a,!0),children:s.jsx(x,{icon:H})}),s.jsx(I,{slot:"end",expand:"block",color:e.autoAdvance?"primary":"medium",title:"Toggle auto-advance at the end of each iteration",onClick:()=>e.set({autoAdvance:!e.autoAdvance}),children:s.jsx(x,{icon:G})}),s.jsx(I,{slot:"end",expand:"block",color:e.globalPaused?"medium":"primary",title:e.globalPaused?"Resume":"Pause",onClick:()=>e.set({globalPaused:!e.globalPaused}),children:s.jsx(x,{icon:e.globalPaused?_:Z})})]}),s.jsxs(P,{children:[s.jsx(A,{children:"Leader Score"}),s.jsx(A,{slot:"end",children:Be(o,{prec:2})})]}),s.jsxs(P,{children:[s.jsx(A,{children:"Active Cars"}),s.jsxs(A,{slot:"end",children:[h,"/",r.length]})]}),s.jsx(P,{children:s.jsx(A,{children:" "})}),s.jsx(P,{children:s.jsx(C,{label:"Track Selection",interface:"alert",value:e.currentTrack,onIonChange:t=>{e.set({currentTrack:t.detail.value})},children:Object.keys(i).map((e=>s.jsx(D,{value:e,children:e},e)))})}),s.jsxs(P,{children:[s.jsxs(A,{children:["Best Score on ",e.currentTrack," Track"]}),s.jsx(A,{slot:"end",children:Be(Math.max(o,e.sotaScore[e.currentTrack]?.score||0),{prec:2})})]}),s.jsx(P,{children:s.jsx(A,{children:" "})}),s.jsxs(P,{children:[s.jsx(A,{children:"Simulation Speed"}),s.jsxs(A,{slot:"end",children:[Be(e.execution.tick?.tps||0)," tps"]})]}),s.jsxs(P,{children:[s.jsx(A,{children:"Rendering Speed"}),s.jsxs(A,{slot:"end",children:[Be(e.execution.tick?.fps||0)," fps"]})]}),s.jsx(P,{children:s.jsx(E,{checked:e.manualControl,onIonChange:t=>{e.set({manualControl:t.detail.checked}),ye.nextGeneration(a,!1)},children:"Manually Controlled Car"})})]})]})})}function qe(){return s.jsxs(p,{children:[s.jsx(He,{}),s.jsx(Ge,{}),s.jsx(Je,{}),s.jsx(Ye,{})]})}function He(){const e=be(),[t,i]=n.useState("");return s.jsxs(R,{children:[s.jsx(z,{children:s.jsx(O,{children:s.jsx(f,{children:s.jsx(m,{size:"12",className:"ion-text-center",children:s.jsx(L,{children:"Data"})})})})}),s.jsxs(N,{children:[s.jsxs(f,{children:[s.jsxs(m,{size:"12",children:["Started"," ",Be.time(e.lastTick??0,{epoch:e.lastReset})]}),s.jsxs(m,{size:"12",children:["This session started"," ",Be.time(e.lastTick??0,{epoch:e.lastLoaded})]}),s.jsxs(m,{size:"12",children:["Last saved"," ",Be.time(e.lastTick??0,{epoch:e.lastSaved})]})]}),s.jsxs(f,{children:[s.jsx(m,{size:"6",children:s.jsx(I,{onClick:()=>{je.load().then((()=>je.save())).then(Qe)},expand:"block",children:"Load"})}),s.jsx(m,{size:"6",children:s.jsx(I,{onClick:()=>je.save(),expand:"block",children:"Save"})}),s.jsx(m,{size:"6",children:s.jsx(I,{onClick:Ze,expand:"block",children:"Load from File"})}),s.jsx(m,{size:"6",children:s.jsx(I,{onClick:_e,expand:"block",children:"Save to File"})}),s.jsx(m,{size:"6",children:s.jsx(I,{onClick:()=>{e.load(he(t)),je.save().then(Qe)},expand:"block",children:"Import Text"})}),s.jsx(m,{size:"6",children:s.jsx(I,{onClick:()=>i(oe(e.save(),e.isDebug())),expand:"block",children:"Export Text"})}),s.jsx(m,{size:"12",children:s.jsx(U,{label:"Data for import/export",labelPlacement:"floating",fill:"outline",rows:5,autoGrow:!0,value:t,onIonInput:e=>i(e.detail.value??"")})})]})]})]})}function Ge(){const e=be(),[t,i]=n.useState(e.ticksPerSec),[r,a]=n.useState(e.rendersPerSec),[o,h]=n.useState(e.saveFrequencySecs);return n.useEffect((()=>{i(e.ticksPerSec)}),[e.ticksPerSec]),n.useEffect((()=>{a(e.rendersPerSec)}),[e.rendersPerSec]),n.useEffect((()=>{h(e.saveFrequencySecs)}),[e.saveFrequencySecs]),s.jsxs(R,{children:[s.jsx(z,{children:s.jsx(O,{children:s.jsx(f,{children:s.jsx(m,{size:"12",className:"ion-text-center",children:s.jsx(L,{children:"Advanced Settings"})})})})}),s.jsxs(N,{children:[s.jsxs(f,{children:[s.jsx(m,{size:"12",children:"If you are having performance issues, increase the time between updates. Faster updating frequncies lead to better experience but might use a lot of CPU."}),s.jsx(m,{size:"6",className:"ion-text-right",children:"Updating frequency:"}),s.jsxs(m,{size:"6",className:"ion-text-center",children:[Math.floor(1e3/e.ticksPerSec),"ms"]}),s.jsx(m,{size:"6"}),s.jsx(m,{size:"6",children:s.jsx(F,{min:6,max:100,step:1,pin:!0,pinFormatter:e=>`${Math.floor(1e3/e)}ms`,value:t,onIonInput:e=>i(e.detail.value),onIonChange:t=>{e.set({ticksPerSec:t.detail.value})},className:"ion-no-padding"})}),s.jsx(m,{size:"6",className:"ion-text-right",children:"Rendering frequency:"}),s.jsxs(m,{size:"6",className:"ion-text-center",children:[Math.floor(1e3/e.rendersPerSec),"ms"]}),s.jsx(m,{size:"6"}),s.jsx(m,{size:"6",children:s.jsx(F,{min:1,max:60,step:1,pin:!0,pinFormatter:e=>`${Math.floor(1e3/e)}ms`,value:r,onIonInput:e=>a(e.detail.value),onIonChange:t=>{e.set({rendersPerSec:t.detail.value})},className:"ion-no-padding"})})]}),s.jsxs(f,{children:[s.jsx(m,{size:"12",children:"Change how often the session is saved in the background. More frequent saving leads to faster backups, but increases CPU and I/O usage"}),s.jsx(m,{size:"6",className:"ion-text-right",children:"Saving frequency:"}),s.jsx(m,{size:"6",className:"ion-text-center",children:Be.time(1e3*e.saveFrequencySecs,{ago:""})}),s.jsx(m,{size:"6"}),s.jsx(m,{size:"6",children:s.jsx(F,{min:1,max:60,step:1,pin:!0,pinFormatter:e=>Be.time(600/e*1e3,{ago:"",len:"tiny"}).replace(":","m:")+"s",value:600/o,onIonInput:e=>h(600/e.detail.value),onIonChange:t=>{e.set({saveFrequencySecs:600/t.detail.value})},className:"ion-no-padding"})})]})]})]})}function Je(){const[e,t]=n.useState(!1);return s.jsxs(R,{children:[s.jsx(z,{children:s.jsx(O,{children:s.jsx(f,{children:s.jsx(m,{size:"12",className:"ion-text-center",children:s.jsx(L,{children:"Reset"})})})})}),s.jsx(N,{children:s.jsxs(f,{children:[s.jsx(m,{size:"12",children:s.jsx(L,{color:"danger",children:"WARNING: this will completely reset your settings and delete all saved progress. Only use this if you want to restart from the beginning, or if something in the settings is so messed up that it is unusable."})}),s.jsx(m,{size:"12",children:s.jsx(B,{justify:"end",checked:e,onIonChange:()=>t((e=>!e)),children:"I understand what this means and still want to reset"})}),s.jsx(m,{size:"12",class:"ion-text-right",children:s.jsx(I,{onClick:function(){e&&(t(!1),je.reset(),le.clear().then(Qe))},disabled:!e,color:e?"danger":"medium",children:"Reset everything"})})]})})]})}function Ye(){const e=be();return e.isDebug()&&s.jsxs(R,{children:[s.jsx(z,{children:s.jsx(O,{children:s.jsx(f,{children:s.jsx(m,{size:"12",className:"ion-text-center",children:s.jsx(L,{children:"Debug Context"})})})})}),s.jsx(N,{children:s.jsx(f,{children:s.jsx(m,{size:"12",children:s.jsx(U,{autoGrow:!0,readonly:!0,value:oe(e,!0)})})})})]})}function _e(){const e=je.singleton,t=`${"idle-self-driving".replace(/\W/g,"_")}-v${"0.9.0".replace(/\W/g,"_")}-${(new Date).toISOString().replace(/\D/g," ").trim().replace(/\D/g,"-")}`,i=oe(e.save(),e.isDebug()),n=new Blob([i],{type:"text/plain"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=t,r.click(),URL.revokeObjectURL(s)}function Ze(){const e=document.createElement("input");e.type="file",e.addEventListener("change",(function(e){const t=e.target.files;if(!t||0===t.length||!t[0])return;const i=new FileReader;i.onload=function(e){const t=e.target?.result;if(!t||"string"!=typeof t)return;const i=je.singleton;i.load(he(t)),i.tick(void 0,"load"),je.save().then(Qe)},i.readAsText(t[0])}),!1),e.click()}function Qe(){W().push("/"),window.location.reload()}function Xe(){const e=be();return n.useEffect((()=>(de.addEventListeners(),le.initialize(),()=>de.removeEventListeners())),[]),n.useEffect((()=>(je.addTickTimer(),()=>je.removeTickTimer())),[e.ticksPerSec]),null}Ue.register=function(e){Fe.get()[e.path]=e,Fe.signal()},Ue.unregister=function(e){delete Fe.get()["string"==typeof e?e:e.path],Fe.signal()},Ue.useTabs=function(){const e=Fe.useHook();return Object.values(e)},Be.number=function(e,t){const i=(Math.log10(Math.abs(e))<3?t?.smallPrec:t?.prec)??t?.prec??0;let n=isFinite(e)?e.toFixed(i):e.toString();return n&&t?.alwaysShowSign&&!"+-".includes(n[0])&&e>=0&&(n="+"+n),n},Be.time=function(e,t){const i=t?.len??"long",n=t?.sep??"long"===i?", ":":",s=(t?.oxfordComma?n:"")+(t?.lastSep??"long"===i?" and ":n),r=t?.now??"long"===i?"now":"",a=t?.never??"long"===i?"never":"",o=t?.ago??"long"===i?"ago":"";if(a&&(e<0||null!=t?.epoch&&(t.epoch<=0||e-t.epoch<0)))return a;if(r&&(0===e||null!=t?.epoch&&e===t.epoch))return r;null!=t?.epoch&&(e-=t.epoch);let h=Math.floor(e/1e3),c=Math.floor(e-1e3*h),l=Math.floor(h/60);h-=60*l;let d=Math.floor(l/60);l-=60*d;let g=Math.floor(d/24);d-=24*g;let u=Math.floor(g/365);if(g-=365*u,t?.millis||(c=0),null!=r&&g+d+l+h+c===0)return r;let p=[];if(p="long"!==i?[u>0?u.toFixed(0):"",g>0?g.toFixed(0):"",d>0||"short"===i?d.toFixed(0):"",l>0||"short"===i?l.toFixed(0):"",(h+c/1e3).toFixed(!t?.millis||"tiny"===i&&0===c?0:3)].map((e=>"short"!==i||1!==e.length&&1!==e.indexOf(".")?e:"0"+e)):[[u,"year"],[g,"day"],[d,"hour"],[l,"minute"],[h,"second",u+g+d+l===0,c]].map((([e,t,i=!1,n=0])=>e>0||n>0||i&&0===e?e.toString()+(n>0?"."+n.toString():"")+" "+t+(1===e?"":"s"):"")),p=p.filter((e=>!!e)),p.length>2){const e=p.pop();p=[p.join(n),e]}let f=p.join(s)+(o?" "+o:"");return f&&t?.alwaysShowSign&&e>=0&&"long"!==i&&!"+-".includes(f[0])&&(f="+"+f),f},Be.word=function(e,t){return e||(e=(Math.abs(Math.abs(t?.count??0)-1)<=(t?.tolerance??.001)?t?.singularName:t?.pluralName)??t?.name),(t?.condition??1)&&(e||t?.allowEmpties)?t?.capitalize??1?(e??"").replace(/([a-z])([A-Z]|_\S)/g,((e,t,i)=>`${t} ${i.slice(-1)}`)).replace(/(?:^|\s)\w(?=\w)/g,(e=>e.toUpperCase())):e??"":""},We.init=()=>{Ue.register({path:"driving",content:s.jsx(We,{}),icon:"speedometerOutline",label:"Driving",title:"Idle Self Driving",from:"/"})},qe.init=()=>{Ue.register({path:"settings",content:s.jsx(qe,{}),icon:"settingsOutline",label:"Settings",title:"Settings"})},Xe.initialize=async function(){await le.initialize(),We.init(),qe.init(),await je.load(),await Promise.all([Ie.loadAll(),Te.loadAll()])},q(),window.addEventListener("load",(async()=>{const e=document.createElement("div");e.id="root",document.body.appendChild(e);const t=o.createRoot(e);await Xe.initialize(),t.render(s.jsx(n.StrictMode,{children:s.jsxs(De,{children:[s.jsx(Xe,{}),s.jsx(Ue,{})]})}))}),!1)}}}))}();
