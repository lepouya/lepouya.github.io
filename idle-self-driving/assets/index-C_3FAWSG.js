var ze=Object.defineProperty;var Le=(s,e,t)=>e in s?ze(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>Le(s,typeof e!="symbol"?e+"":e,t);import{r as v,u as Ne,a as He,j as i,I as ne,b as C,c as g,d as M,e as D,f as P,g as Fe,h as Be,i as Ue,k as U,l as We,m as qe,R as Ie,n as Ge,o as Ye,p as Je,q as Ze,s as Ce,t as Ke,v as Qe,w as H,x as Xe,y as Ve,z as Te,A as pe,B as _e,C as re,D as ae,E as oe,F as X,G as ce,H as de,J as et,K as tt,L as st,M as it}from"./react-W099cFCF.js";import{S as nt}from"./ionic-Bb5Q-mFB.js";import{I as rt,b as at,p as $e,r as Ae,a as ot,c as ct}from"./ionicons-CiEm7yBE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();function $(s=0,e=0,t=1){return isNaN(s)||s<e?e:s>t?t:s}class lt extends Error{}class Se extends Error{}class ht{constructor(e,t){c(this,"canvas");c(this,"options");this.canvas=e,this.options=t}get dataURL(){return this.canvas.toDataURL(this.options.format,this.options.quality)}get blob(){return new Promise((e,t)=>this.canvas.toBlob(n=>n?e(n):t(new Se),this.options.format,this.options.quality))}getPixels(e,t,n,r){var m,j;const a=this.canvas.width,o=this.canvas.height,l=se(e,0,a-1),d=se(t,0,o-1),h=se(n,1,a-l),f=se(r,1,o-d),x=(j=(m=this.canvas)==null?void 0:m.getContext("2d",{alpha:!1}))==null?void 0:j.getImageData(l,d,h,f);if(!x)throw new Se;return{buffer:new Uint32Array(x.data.buffer),startX:l-e,startY:d-t,width:h,height:f}}}async function Q(s,e){var l;const t=Object.assign({},gt,e),n=[...s||[],...(t==null?void 0:t.sources)||[]],r=await Promise.all(n.map(d=>dt(d,t)));let a=t.reuse instanceof HTMLCanvasElement?t.reuse:(l=t.reuse)==null?void 0:l.canvas;a||(a=window.document.createElement("canvas")),a.width=t.width||Math.max(...r.map(([d])=>d.width)),a.height=t.height||Math.max(...r.map(([d])=>d.height)),a.className=[...Array.isArray(t.className)?t.className:[t.className],"composed-image"].join(" "),t.style&&Object.assign(a.style,t.style);const o=a.getContext("2d");t.clear&&o.clearRect(0,0,a.width,a.height);for(let[d,h]of r){o.save();let f=R(h.crop,0,"x")||0,x=R(h.crop,1,"y")||0,u=R(h.crop,2,"w")||d.width,m=R(h.crop,3,"h")||d.height,j=R(h.position,0,"x")||0,S=R(h.position,1,"y")||0,b=(R(h.stretch,0,"sx")||1)*u,L=(R(h.stretch,1,"sy")||1)*m,B=(R(h.rotate,2,"a")||0)*(Math.PI/180),O=typeof h.rotate=="number"?void 0:h.rotate,k=(R(O,0,"x")??.5)*b+j,F=(R(O,1,"y")??.5)*L+S,we=R(h.scale,2,"sx")??1,ye=R(h.scale,3,"sy")??1,je=typeof h.scale=="number"?void 0:h.scale,ve=(R(je,0,"x")??.5)*b+j,be=(R(je,1,"y")??.5)*L+S;o.globalAlpha=h.opacity??1,o.globalCompositeOperation=h.composition??"source-over",o.imageSmoothingEnabled=h.smoothing!==!1&&h.smoothing!=="disabled",o.imageSmoothingQuality=h.smoothing==="medium"||h.smoothing==="high"?h.smoothing:"low",Array.isArray(h.filter)?o.filter=h.filter.join(" "):h.filter&&(o.filter=h.filter),o.filter||(o.filter="none"),o.resetTransform(),B!==0&&(o.translate(k,F),o.rotate(B),o.translate(-k,-F)),(we!==1||ye!==1)&&(o.translate(ve,be),o.scale(we,ye),o.translate(-ve,-be)),o.imageSmoothingEnabled||(f=~~f,x=~~x,u=~~u,m=~~m,j=~~j,S=~~S,b=~~b,L=~~L),o.drawImage(d,f,x,u,m,j,S,b,L),o.restore()}return new ht(a,t)}function dt(s,e){return new Promise((t,n)=>{var o,l,d,h;const r=typeof s=="string"?{src:s}:s;r.src=(r.src||"").trim(),!r.src||r.src==="transparent"?r.src=ut:r.src.startsWith("plain:")?r.src=ft.replace("{color}",encodeURIComponent(r.src.slice(6).trim())).replace("{width}",((o=e==null?void 0:e.width)==null?void 0:o.toString())||"100%").replace("{height}",((l=e==null?void 0:e.height)==null?void 0:l.toString())||"100%"):r.src.startsWith("<svg")&&(r.src.includes("xmlns=")||(r.src=r.src.replace("<svg",'<svg xmlns="http://www.w3.org/2000/svg"')),r.src="data:image/svg+xml;utf8,"+encodeURIComponent(r.src.replace("{width}",((d=e==null?void 0:e.width)==null?void 0:d.toString())||"100%").replace("{height}",((h=e==null?void 0:e.height)==null?void 0:h.toString())||"100%")));const a=new Image;a.onerror=()=>n(new lt),a.onload=()=>t([a,r]),a.crossOrigin="anonymous",a.src=r.src})}const gt={format:"image/png",quality:.92},ut="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",ft='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1" preserveAspectRatio="none"     width="{width}" height="{height}">  <rect x="0" y="0" width="1" height="1" fill="{color}" /></svg>';function R(s,...e){let t;if(!s||typeof s=="number")t=s??void 0;else if(Array.isArray(s)){for(let n of e)if(typeof n=="string"&&(n=parseInt(n)),typeof n=="number"&&isFinite(n)){const r=s[n];if(r!=null&&typeof r=="number"){t=r;break}}}else if(typeof s=="object"){for(let n of e)if(typeof n=="string"||typeof n=="number"){const r=s[n];if(r!=null&&typeof r=="number"){t=r;break}}}for(let n of e)n&&typeof n=="object"&&(n.def!=null&&t==null&&(t=n.def),n.min!=null&&t!=null&&(t=Math.max(t,n.min)),n.max!=null&&t!=null&&(t=Math.min(t,n.max)));return t}function se(s=0,e=0,t=1){return isNaN(s)||s<e?~~e:s>t?~~t:~~s}function te(s){const e={};function t(){return typeof s=="function"?s():s}function n(){return Date.now().toString(36)+Math.random().toString(36).slice(1)}function r(h,f){const x=f||n();return e[x]=h,x}function a(h){delete e[h]}function o(){return e}function l(){const h={ref:t()};Object.values(e).forEach(f=>f(h))}function d(){const[h,f]=v.useState(n),[x,u]=v.useState(()=>({ref:t()}));return v.useEffect(()=>{const m=r(u,h);return f(m),()=>{a(h),a(m)}},[h]),Ne(()=>{const m=r(u,h);f(m)},[h]),He(()=>{a(h)},[h]),x.ref}return{useHook:d,signal:l,register:r,unregister:a,getRegistry:o,get:t}}function le(s){if(le.skipEncoding||!s)return s;const e=s.startsWith(".."),t=(e?s:Math.random().toString(36)).substring(2,10);return(e?"":".."+t)+(e?s.slice(10):s).split("").map(n=>n.charCodeAt(0)).map((n,r)=>String.fromCharCode(n^t.charCodeAt(r%8))).join("")}le.skipEncoding=!1;function Pe(s,e){const t=[];function n(r,a){if(!(r&&r.startsWith("_")))return!a||typeof a!="object"||Array.isArray(a)?a:a instanceof Date?a.toJSON():Object.keys(a).length===0||t.includes(a)?void 0:(t.push(a),a)}return JSON.stringify(s,n,e)}function he(s,e=!1){const t=Pe(s,e?2:void 0);return e?t:window.btoa(le(encodeURIComponent(t)))}function ke(s){if(!s||typeof s!="string")return s??void 0;try{const e=JSON.parse(decodeURIComponent(le(window.atob(s))));if(e)return e}catch{}try{const e=JSON.parse(s);if(e)return e}catch{}return s}const Y={db:void 0};function z(){return z.initialize(),Y.db}z.initialize=async function(){return Y.db||(Y.db=new nt,Y.db=await Y.db.create()),Y.db};z.write=async function(s,e,t=!1){const n=he(e,t),r=await z.initialize();return await(r==null?void 0:r.set(s,n))};z.read=async function(s){const e=await z.initialize(),t=await(e==null?void 0:e.get(s));return ke(t)};z.clear=async function(){const s=await z.initialize();await(s==null?void 0:s.clear())};function E(s,e){E.register(s,e)}E.register=function(s,e){s=s.toLowerCase().replace(/\W/g,""),J[s]??(J[s]=[]),J[s].includes(e)||J[s].push(e)};E.addEventListeners=function(){document.addEventListener("keydown",Re),document.addEventListener("keyup",De),Ee()};E.removeEventListeners=function(){document.removeEventListener("keydown",Re),document.removeEventListener("keyup",De),Ee()};E.test=function(s){return V[s.toLowerCase().replace(/\W/g,"")]??!1};E.some=function(...s){return s.some(E.test)};E.all=function(...s){return s.every(E.test)};const mt=["TEXTAREA","INPUT"],J={},V={};function Re(s){if(Oe(s.target))return;const e=s.key.toLowerCase().replace(/\W/g,"");V[e]=!0;const t=J[e];t&&t.length>0&&t.forEach(n=>{n(s)&&(s.preventDefault(),s.stopPropagation())})}function De(s){if(Oe(s.target))return;const e=s.key.toLowerCase().replace(/\W/g,"");V[e]=!1}function Ee(){Object.keys(V).forEach(s=>V[s]=!1)}function Oe(s){try{return s&&mt.includes(s.tagName.toUpperCase())}catch{return!1}}function xt(s=0,e=1){const t=1-Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*n)*e+s}class _{constructor(e){this.config=e,this.validate(),this.regularize()}static init(e,t,n){if(!e)throw new Error("Invalid input count");if(!t)throw new Error("Invalid output count");n||(n=[]);const r=[];for(let a=0;a<n.length+1;a++){const o=a===0?e:n[a-1],l=a===n.length?t:n[a],d=[];for(let h=0;h<l;h++){const f=[];for(let x=0;x<o+1;x++)f.push(0);d.push(f)}r.push(d)}return new _({input:e,output:t,hidden:n,weights:r})}validate(){const{input:e,hidden:t,output:n,weights:r}=this.config;if(e<1)throw new Error("Invalid input count");if(t.length<0)throw new Error("Invalid hidden layer count");if(n<1)throw new Error("Invalid output count");if(r.length!==t.length+1)throw new Error("Invalid weight count");for(let a=0;a<r.length;a++){const o=a===0?e:t[a-1],l=a===t.length?n:t[a];if(r[a].length!==l)throw new Error(`Invalid row count for weights layer ${a}`);for(let d=0;d<r[a].length;d++)if(r[a][d].length!==o+1)throw new Error(`Invalid col count for weights layer ${a} neuron ${d}`)}}regularize(){const e=this.config.weights,t=2;for(let n=0;n<e.length;n++)for(let r=0;r<e[n].length;r++)for(let a=0;a<e[n][r].length;a++)e[n][r][a]=$(e[n][r][a],-2,t)}eval(e){const t=this.config.weights;let n=e;for(let r=0;r<t.length;r++){let a=[];for(let o=0;o<t[r].length;o++){let l=t[r][o][n.length-1];for(let d=0;d<n.length-1;d++)l+=n[d]*t[r][o][d];a.push(this.activation(l))}n=a}return n}activation(e){return e<-1?-1:e>1?1:e}randomStep(e){return new _({...this.config,weights:this.config.weights.map(t=>t.map(n=>n.map(r=>xt(r,e))))})}}const w=class w{constructor(e,t="",n=.5,r=!0){c(this,"renderImage");c(this,"sensorImage");c(this,"width",p.singleton.carWidth);c(this,"height",p.singleton.carHeight);c(this,"track",null);c(this,"position",{x:0,y:0});c(this,"angle",0);c(this,"speed",0);c(this,"steering",0);c(this,"acceleration",0);c(this,"odometer",0);c(this,"laps",0);c(this,"inCrossing",!1);c(this,"totalTicks",0);c(this,"startTime",0);c(this,"endTime",0);c(this,"collided",!1);c(this,"pastTracking",[]);c(this,"sensorsReady",!0);c(this,"sensorReadingTime",0);c(this,"sensorReadings",[]);c(this,"visualizeSensors",!1);c(this,"net",null);if(this.name=e,this.color=t,this.fudgeFactor=n,!t){const a=[32,64,128].map(o=>$(~~(Math.random()*o*2),0,255));this.color="#"+a.map(o=>o.toString(16).padStart(2,"0")).join("")}e&&r&&(w.registry.get()[e]=this)}static useHook(){const e=w.registry.useHook();return Object.values(e)}get mask(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        rx="${this.width/4}"
        ry="${this.height/4}"
        fill="${A.color.vehicle}"
        shape-rendering="crispEdges"
      />`,"</svg>"].join("")}get image(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        rx="${this.width/4}"
        ry="${this.height/4}"
        fill="${this.laps>=3?"green":this.collided?"red":this.color}"
      />`,[[0,0],[this.width*3/4,0],[this.width*3/4,this.height*3/4],[0,this.height*3/4]].map(([e,t])=>`<rect
            x="${e}"
            y="${t}"
            width="${this.width/4}"
            height="${this.height/4}"
            rx="${this.width/8}"
            ry="${this.height/8}"
            fill="black"
          />`),"</svg>"].join("")}get canvas(){var e;return(e=this.renderImage)==null?void 0:e.canvas}async fetchImageData(){return this.renderImage=await Q([],{reuse:this.renderImage,clear:!0,sources:[{src:this.image,opacity:this.net?.666:1}],width:this.width,height:this.height}),this.renderImage}get score(){const e=Date.now(),t=this.odometer/Math.max(this.width,this.height),n=((this.endTime||e)-(this.startTime||e))/1e3;return{distance:t,time:n,laps:this.laps,success:!this.collided&&this.laps>=3&&this.startTime>0,score:this.startTime>0?Math.max(0,t-n)+(this.laps+1)**2*10:0}}placeOnTrack(e){this.track=e,this.position.x=e.startingPoint.x,this.position.y=e.startingPoint.y,this.angle=e.startingAngle,this.speed=0,this.steering=0,this.acceleration=0,this.position.x-=e.startingDirection.x*this.width/2,this.position.y-=e.startingDirection.y*this.height/2;const t=this.net?Math.random()*e.roadThickness-e.roadThickness/2:0;this.position.x+=t*this.fudgeFactor*e.startingDirection.y,this.position.y-=t*this.fudgeFactor*e.startingDirection.x,this.odometer=0,this.laps=0,this.inCrossing=!1,this.startTime=0,this.endTime=0,this.collided=!1,this.fetchImageData();const n=Math.max(this.width,this.height,this.track.roadThickness)+1;this.pastTracking=[{x:e.startingPoint.x-e.startingDirection.x*n,y:e.startingPoint.y-e.startingDirection.y*n}],this.sensorsReady=!0,this.sensorReadingTime=Date.now()}endRun(e=!0){var r;const t=p.singleton;if(this.endTime=Date.now(),this.startTime||(this.startTime=this.endTime),this.inCrossing=!1,this.collided=e,this.fetchImageData(),!this.track||!this.net||this.score.score<=0)return;const n=Math.max(...Object.values(t.sotaScore).map(a=>a?a.score:0));this.score.score>(n??0)?(t.sotaNet=this.net.config,t.sotaScore[this.track.name]=this.score,w.log(this.name,"all-time highscore")):this.score.score>(((r=t.sotaScore[this.track.name])==null?void 0:r.score)??0)&&(w.log(this.name,"highscore on track"),t.sotaScore[this.track.name]=this.score)}render(e,t=!1,n){if(this.canvas){if(e.save(),e.translate(~~this.position.x,~~this.position.y),e.rotate(this.angle),(n||this.visualizeSensors||this.name==="Manual")&&A.registry.get().forEach((r,a)=>r.render(e,this.sensorReadings[a])),e.drawImage(this.canvas,~~(-this.width/2),~~(-this.height/2)),t){const r=Math.abs(Math.sin(Date.now()/200)+1);e.filter=`blur(${r*5}px) brightness(${r*100}%)`,e.drawImage(this.canvas,~~(-this.width/2),~~(-this.height/2))}e.restore()}}isClickedOn(e,t){const n=Math.sqrt(this.width**2+this.height**2)/2;return e>this.position.x-n&&e<this.position.x+n&&t>this.position.y-n&&t<this.position.y+n}tick(e){if(this.collided||!this.track)return;if(this.name==="Manual")this.manualControl();else{const a=this.score;if(a.score<-10||this.totalTicks>3&&a.score<=0)return w.log(this.name,"not going anywhere"),this.endRun();if(this.totalTicks>3&&a.score<=a.time/2)return w.log(this.name,"going too slow"),this.endRun();if(a.laps>=3)return this.endRun()}const t=p.singleton;if(this.totalTicks+=e,this.steering=$(this.steering,-1,1),this.steering=$(this.steering,-this.speed,this.speed),Math.abs(this.steering)>=.01&&(this.angle+=t.maxSteering*this.steering*e,this.steering-=t.friction*Math.sign(this.steering)*e,this.speed-=t.friction*this.speed*e),this.angle>Math.PI?this.angle-=Math.PI*2:this.angle<-Math.PI&&(this.angle+=Math.PI*2),this.acceleration=$(this.acceleration,-1,1),Math.abs(this.acceleration)>=.01?(this.speed+=t.maxAcceleration*this.acceleration*e,this.acceleration-=t.friction*Math.sign(this.acceleration)*e):this.speed-=t.friction*this.speed*e,this.speed=$(this.speed,0,t.maxSpeed),this.position.x+=Math.cos(this.angle)*this.speed*e,this.position.y+=Math.sin(this.angle)*this.speed*e,this.odometer+=this.speed*e,this.position.x<=0||this.position.x>=this.track.width||this.position.y<=0||this.position.y>=this.track.height)return w.log(this.name,"out of bounds"),this.endRun();const n=Math.max(this.width,this.height,this.track.roadThickness),r=this.pastTracking.map(a=>Math.hypot(a.x-this.position.x,a.y-this.position.y));if(r.length===0||r.every(a=>a>n))this.pastTracking.unshift({x:this.position.x,y:this.position.y}),this.pastTracking.length>3&&this.pastTracking.pop();else if(r.length>1&&r.slice(1).some(a=>a<n))return w.log(this.name,"went back on track"),this.endRun();this.checkSensors()}async renderSensors(){var e;return Q([],{width:p.singleton.trackWidth,height:p.singleton.trackHeight,sources:[{src:((e=this.track)==null?void 0:e.mask)||"transparent",smoothing:!1},{src:this.mask,position:{x:this.position.x-this.width/2,y:this.position.y-this.height/2},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1},...A.registry.get().map(t=>({src:t.mask,position:{x:this.position.x-t.range,y:this.position.y-t.range},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1}))]})}checkSensors(){if(!(!this.track||this.collided)&&!(!this.sensorsReady&&Date.now()-this.sensorReadingTime<100))return this.sensorsReady=!1,Q([],{width:this.track.width,height:this.track.height,reuse:this.sensorImage,clear:!0,sources:[{src:this.track.mask,smoothing:!1},{src:this.mask,position:{x:this.position.x-this.width/2,y:this.position.y-this.height/2},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1}]}).then(e=>{if(this.sensorImage=e,this.checkCollision(e))return this.endRun();if(this.sensorReadings=A.readAll(e,this.position.x,this.position.y,this.angle),this.net){const n=this.net.eval([...this.sensorReadings,this.acceleration,this.steering,this.speed/p.singleton.maxSpeed,this.angle/Math.PI]);this.acceleration=n[0],this.steering=n[1]}}).catch(e=>{console.error("Error reading sensors",this.name,e)}).finally(()=>{this.sensorsReady=!0,this.sensorReadingTime=Date.now()})}checkCollision(e){const t=~~Math.max(this.width/2,this.height/2)+1,n=e.getPixels(this.position.x-t,this.position.y-t,t*2,t*2).buffer,r=n.some(h=>A.check(h,A.vehicle,A.lapLine)),a=n.some(h=>A.check(h,A.vehicle,A.offTrack)),o=this.angle,l=this.track.startingAngle;let d=Math.abs((o<0?o+Math.PI*2:o)-(l<0?l+Math.PI*2:l));if(d>Math.PI&&(d=Math.PI*2-d),r&&!this.inCrossing){if(this.inCrossing=!0,d>Math.PI/2)return w.log(this.name,"crossed the wrong way"),!0;if(!this.startTime)this.startTime=Date.now();else{if(this.odometer<this.width+this.height+this.track.roadThickness)return w.log(this.name,"incomplete lap"),!0;this.laps++,w.log(this.name,"lap",this.laps,"score",~~this.score.score)}}else if(!r&&this.inCrossing&&(this.inCrossing=!1,d>Math.PI/2))return w.log(this.name,"turned around"),!0;return a?(w.log(this.name,"went off track"),!0):!1}manualControl(){E.some("ArrowDown","S")?this.acceleration=$(this.acceleration-.1,-1,-.1):E.some("ArrowUp","W")?this.acceleration=$(this.acceleration+.1,.1,1):this.acceleration=0,E.some("ArrowLeft","A")?this.steering=$(this.steering-.1,-1,-.1):E.some("ArrowRight","D")?this.steering=$(this.steering+.1,.1,1):this.steering=0}static renderAll(e){const t=Object.values(w.registry.get()).sort((n,r)=>n.score.score-r.score.score);t.forEach((n,r)=>n.render(e,r===t.length-1))}static tickAll(e){var t;if(Object.values(w.registry.get()).forEach(n=>n.tick(e)),p.singleton.autoAdvance){const n=Object.values(w.registry.get()),r=Date.now()-1e3;if(n.every(a=>a.collided&&a.laps<3&&a.endTime<r)){const a=(t=n[0])==null?void 0:t.track;a&&w.nextGeneration(a,!1)}}}static async nextGeneration(e,t=!1){var m,j,S,b,L,B,O;const n=p.singleton,r=w.registry.get();n.manualControl&&(!r.Manual||(((m=r.Manual)==null?void 0:m.collided)??!0)||(((S=(j=r.Manual)==null?void 0:j.track)==null?void 0:S.name)??"")!==e.name)?new w("Manual","#33eeee").placeOnTrack(e):!n.manualControl&&r.Manual&&delete r.Manual;const a=Object.values(r).filter(k=>k.name!=="Manual"&&k.net);if(!t&&a.some(k=>!k.collided&&k.track===e))return;a.forEach(k=>k.endRun()),a.sort((k,F)=>F.score.score-k.score.score);const o=new _(n.sotaNet),l=n.sotaScore[e.name],d=((b=a[0])==null?void 0:b.net)??o,h=((L=a[0])==null?void 0:L.score)??l,f=Math.floor(Math.random()*a.length),x=((B=a[f])==null?void 0:B.net)??d,u=((O=a[f])==null?void 0:O.score)??h;for(let k=0;k<n.numSimulations.globalBest;k++){const F=new w(`AI.globalBest.${k}`);F.net=o.randomStep(k===0?0:ge(l))}for(let k=0;k<n.numSimulations.trackBest;k++){const F=new w(`AI.trackBest.${k}`);F.net=d.randomStep(k===0&&(h==null?void 0:h.score)!==(l==null?void 0:l.score)?0:ge(h))}for(let k=0;k<n.numSimulations.trackRandom;k++){const F=new w(`AI.trackRandom.${k}`);F.net=x.randomStep(ge(u))}n.numIterations++,w.log("Starting iteration",n.numIterations),Object.values(r).forEach(k=>{k.track||k.placeOnTrack(e)}),await Promise.all(Object.values(r).map(k=>k.fetchImageData())),p.save(),w.registry.signal()}static log(...e){const t=e.map(n=>n?typeof n=="string"?n:typeof n=="number"?String(~~n):Pe(n):null).filter(n=>!!n).join(" ");for(console.log(t),w.events.push(t);w.events.length>15;)w.events.shift()}};c(w,"registry",te({})),c(w,"events",[]);let N=w;function ge(s){return!s||!s.score||!s.distance||!s.time?1:$(Math.sqrt(10/s.score),.1,1)}const y=class y{constructor(e){c(this,"ticksPerSec",100);c(this,"rendersPerSec",30);c(this,"saveFrequencySecs",10);c(this,"minUpdateSecs",.01);c(this,"maxUpdateSecs",.25);c(this,"maxTickSecs",.1);c(this,"globalTimeDilation",1);c(this,"globalPaused",!1);c(this,"lastReset",Date.now());c(this,"lastSaved",0);c(this,"lastLoaded",Date.now());c(this,"lastRender",0);c(this,"lastTick");c(this,"onTickComplete");c(this,"execution",{});c(this,"helpDismissed");c(this,"trackWidth",800);c(this,"trackHeight",600);c(this,"currentTrack","Basic");c(this,"autoAdvance",!1);c(this,"carWidth",20);c(this,"carHeight",15);c(this,"friction",.1);c(this,"maxSpeed",100);c(this,"maxAcceleration",25);c(this,"maxSteering",Math.PI/2);c(this,"manualControl",!1);c(this,"renderSensors",!1);c(this,"sensors",[{range:100,angle:0},{range:100,angle:Math.PI/6},{range:100,angle:-Math.PI/6},{range:100,angle:Math.PI/3},{range:100,angle:-Math.PI/3}]);c(this,"numIterations",0);c(this,"numSimulations",{globalBest:4,trackBest:4,trackRandom:2});c(this,"sotaScore",{});c(this,"sotaNet",_.init(this.sensors.length+4,2,[]).config);c(this,"timer",null);y.singleton=this,this.load(e)}static isDebug(){return window.location.href.toLowerCase().includes("debug")}static useHook(){return y.registry.useHook()}static set(e){return y.singleton.set(e)}static tick(e,t){return y.singleton.tick(e,t,y.save,y.registry.signal)}static async save(){y.singleton.tick(void 0,"save");const e=await z.write("Settings",y.singleton.save());return y.registry.signal(),e}static async load(){return y.singleton.load(await z.read("Settings")),y.singleton.tick(void 0,"load"),y.registry.signal(),y.singleton}static reset(e){return y.singleton=new y(e),y.registry.signal(),y.singleton}static addTickTimer(){y.removeTickTimer();const e=setInterval(()=>y.tick(void 0,"tick"),1e3/y.singleton.ticksPerSec);y.singleton.timer=e}static removeTickTimer(){y.singleton.timer&&clearInterval(y.singleton.timer),y.singleton.timer=null}set(e){let t;for(t in e)e[t]==null||e[t]==null||(typeof this[t]=="object"&&typeof e[t]=="object"?Object.assign(this[t],e[t]):this[t]=e[t]);return y.registry.signal(),this}load(e){if(e){if(typeof e=="string")return this.load(JSON.parse(e))}else return this;return this.set(e),this.lastLoaded=Date.now(),this}save(){return this.lastSaved=Date.now(),this}tick(e=Date.now(),t="unknown",n,r){var x,u;const a=this.lastTick??e;let o=$((e-a)/1e3,0,this.maxUpdateSecs);if(o<this.minUpdateSecs&&this.lastTick!=null)return[];this.lastTick=e;const l=e-o*1e3,d={},h=1/this.globalTimeDilation,f=[o,1];for(;o>0;){const m=$(o,this.minUpdateSecs,this.maxTickSecs);o-=m,t==="tick"&&N.tickAll(this.globalPaused?0:m*h)}return this.execution[t]={lastTick:e,lastDelta:(e-l)/1e3,lastResult:Object.values(d).flat().filter((m,j,S)=>S.indexOf(m)===j),tps:(((x=this.execution[t])==null?void 0:x.tps)||0)*.8+f[1]/f[0]*.2,fps:((u=this.execution[t])==null?void 0:u.fps)||0},this.onTickComplete&&this.onTickComplete((e-l)/1e3,t),n&&this.lastTick-this.lastSaved>=this.saveFrequencySecs*1e3&&this.lastTick-this.lastLoaded>=this.saveFrequencySecs*1e3&&(this.lastSaved=this.lastTick,n(this)),r&&this.lastTick-this.lastRender>=1e3/this.rendersPerSec&&(this.execution[t].fps=(this.execution[t].fps||0)*.8+1e3/(this.lastTick-this.lastRender)*.2,this.lastRender=this.lastTick,r(this)),this.execution[t].lastResult}};c(y,"singleton",new y),c(y,"registry",te(()=>y.singleton));let p=y;const I=class I{constructor(e,t){c(this,"renderImage");c(this,"path");this.range=e,this.angle=t;const n=e*Math.cos(t),r=e*Math.sin(t);this.path=`M ${~~e} ${~~e} l ${~~n} ${~~r}`}static useHook(){return I.registry.useHook()}get maskColor(){return I.radar}get mask(){return[`<svg
        width="${this.range*2}px"
        height="${this.range*2}px"
        viewBox="0 0 ${this.range*2} ${this.range*2}"
      >`,`<path
        d="${this.path}"
        stroke="${I.color.radar}"
        stroke-width="2px"
        stroke-linecap="butt"
        fill="none"
        shape-rendering="crispEdges"
      />`,"</svg>"].join("")}get image(){return[`<svg
        width="${this.range*2}px"
        height="${this.range*2}px"
        viewBox="0 0 ${this.range*2} ${this.range*2}"
      >`,`<path
        d="${this.path}"
        stroke="green"
        stroke-width="2px"
        stroke-linecap="round"
        fill="none"
      />`,"</svg>"].join("")}get canvas(){var e;return(e=this.renderImage)==null?void 0:e.canvas}async fetchImageData(){return this.renderImage=await Q([this.image],{reuse:this.renderImage,clear:!0,width:this.range*2,height:this.range*2}),this.renderImage}render(e,t=1){if(!this.canvas)return;const n=~~this.range,r=~~(this.range*t);e.globalCompositeOperation="lighter",e.drawImage(this.canvas,-n,-n,n*2,n*2),e.globalCompositeOperation="source-over",e.drawImage(this.canvas,-r,-r,r*2,r*2)}read(e,t,n,r,a,o){const l=Math.cos(this.angle+o),d=Math.sin(this.angle+o);let h=0;for(let f=0;f<this.range;f++){const x=$(~~(a+f*d),0,n-1),u=$(~~(r+f*l),0,t-1);if(I.check(e[x*t+u],I.offTrack))break;h=f}return $(h/this.range,0,1)}static check(e,...t){const n=pt(t.reduce((r,a)=>r|a,0));return(e&n)===n}static async loadAll(){const e=p.singleton.sensors.map(({range:t,angle:n})=>new I(t,n));e.forEach(t=>I.registry.get().push(t)),await Promise.all(e.map(t=>t.fetchImageData())),I.registry.signal()}static readAll(e,t,n,r){const a=~~Math.max(...I.registry.get().map(x=>x.range)),{buffer:o,startX:l,startY:d,width:h,height:f}=e.getPixels(~~t-a,~~n-a,a*2,a*2);return I.registry.get().map(x=>x.read(o,h,f,a-l,a-d,r))}};c(I,"registry",te([])),c(I,"available",0),c(I,"offTrack",8388608),c(I,"lapLine",32768),c(I,"vehicle",8355711),c(I,"radar",128),c(I,"color",{available:K(I.available),offTrack:K(I.offTrack),lapLine:K(I.lapLine),vehicle:K(I.vehicle),radar:K(I.radar)});let A=I;function K(s){return"#"+s.toString(16).padStart(6,"0")}function pt(s){return(s&16711680)>>16|(s&255)<<16|s&65280}const Z=class Z{constructor(e){c(this,"renderImage");c(this,"width",p.singleton.trackWidth);c(this,"height",p.singleton.trackHeight);this.name=e}get startingAngle(){return Math.atan2(this.startingDirection.y,this.startingDirection.x)}get mask(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        fill="${A.color.offTrack}"
        shape-rendering="crispEdges"
      />`,this.path.map(e=>`<path
            d="${e}"
            stroke="${A.color.available}"
            stroke-width="${this.roadThickness}px"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
            shape-rendering="crispEdges"
          />`),`<path
        d="M ${this.startingPoint.x} ${this.startingPoint.y} l ${Math.sign(this.startingDirection.x)*this.laneMarkingThickness} ${Math.sign(this.startingDirection.y)*this.laneMarkingThickness}"
        stroke="${A.color.lapLine}"
        stroke-width="${this.roadThickness}px"
        stroke-linecap="butt"
        fill="none"
      />`,"</svg>"].join("")}get image(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        fill="lightgreen"
      />`,this.path.map(e=>`<path
            d="${e}"
            stroke="salmon"
            stroke-width="${this.roadThickness+this.laneMarkingThickness*2}px"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />`),this.path.map(e=>`<path
            d="${e}"
            stroke="lightgray"
            stroke-width="${this.roadThickness}px"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />`),this.path.map(e=>`<path
            d="${e}"
            stroke="yellow"
            stroke-width="${this.laneMarkingThickness}px"
            stroke-dasharray="
              ${this.laneMarkingThickness*3},
              ${this.laneMarkingThickness*5}"
            stroke-dashoffset="${this.laneMarkingThickness}"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />`),`<path
        d="M ${this.startingPoint.x} ${this.startingPoint.y} l ${Math.sign(this.startingDirection.x)*this.laneMarkingThickness} ${Math.sign(this.startingDirection.y)*this.laneMarkingThickness}"
        stroke="white"
        stroke-width="${this.roadThickness}px"
        stroke-linecap="butt"
        fill="none"
      />`,"</svg>"].join("")}get canvas(){var e;return(e=this.renderImage)==null?void 0:e.canvas}async fetchImageData(){return this.renderImage=await Q([this.image],{reuse:this.renderImage,clear:!0,width:this.width,height:this.height}),this.renderImage}render(e){this.canvas&&e.drawImage(this.canvas,0,0)}static async loadAll(){const e=[new kt("Basic"),new wt("Advanced"),new yt("Oval"),new jt("Curvy")];e.forEach(t=>{Z.registry.get()[t.name]=t}),await Promise.all(e.map(t=>t.fetchImageData())),Z.registry.signal()}static useHook(){return Z.registry.useHook()}};c(Z,"registry",te({}));let W=Z;class kt extends W{get path(){return["M 730 70 h -360 v 200 h -300 v 260 h 400 l 260 -260 v -160 Z"]}get roadThickness(){return 80}get laneMarkingThickness(){return 3}get startingPoint(){return{x:150,y:530}}get startingDirection(){return{x:1,y:0}}}class wt extends W{get path(){return["M 750 50 h -300 l -200 100 l -100 -70 h -100 v 450 h 300 v -150 h 50 v -200 h 100 v 380 h 150 Z"]}get roadThickness(){return 60}get laneMarkingThickness(){return 3}get startingPoint(){return{x:600,y:50}}get startingDirection(){return{x:1,y:0}}}class yt extends W{get path(){return["M 400 100 Q 100 100 100 300 T 400 500 T 700 300 T 400 100 Z"]}get roadThickness(){return 100}get laneMarkingThickness(){return 3}get startingPoint(){return{x:400,y:100}}get startingDirection(){return{x:-1,y:0}}}class jt extends W{get path(){return["M 100 300 c 0 100 50 200 150 200 s 50 -150 150 -150 s 50 150 150 150 s 150 -100 150 -200 s 0 -100 -100 -100 s -100 0 -100 -100 s 0 0 -100 0 s 0 0 -100 0 s 0 -50 -100 -50 s -100 150 -100 250 Z"]}get roadThickness(){return 70}get laneMarkingThickness(){return 3}get startingPoint(){return{x:400,y:100}}get startingDirection(){return{x:-1,y:0}}}function T(s,e){return s==null||s==null||typeof s=="string"?T.word(s??void 0,e):s instanceof Date?T.time(s.getTime(),e):typeof s=="number"?T.number(s,e):""}T.number=function(s,e){const t=(Math.log10(Math.abs(s))<3?e==null?void 0:e.smallPrec:e==null?void 0:e.prec)??(e==null?void 0:e.prec)??0;let n=isFinite(s)?s.toFixed(t):s.toString();return n&&(e!=null&&e.alwaysShowSign)&&!"+-".includes(n[0])&&s>=0&&(n="+"+n),n};T.time=function(s,e){const t=(e==null?void 0:e.len)??"long",n=(e==null?void 0:e.sep)??t==="long"?", ":":",r=(e!=null&&e.oxfordComma?n:"")+((e==null?void 0:e.lastSep)??t==="long"?" and ":n),a=(e==null?void 0:e.now)??t==="long"?"now":"",o=(e==null?void 0:e.never)??t==="long"?"never":"",l=(e==null?void 0:e.ago)??t==="long"?"ago":"";if(o&&(s<0||(e==null?void 0:e.epoch)!=null&&(e.epoch<=0||s-e.epoch<0)))return o;if(a&&(s===0||(e==null?void 0:e.epoch)!=null&&s===e.epoch))return a;(e==null?void 0:e.epoch)!=null&&(s-=e.epoch);let d=Math.floor(s/1e3),h=Math.floor(s-d*1e3),f=Math.floor(d/60);d-=f*60;let x=Math.floor(f/60);f-=x*60;let u=Math.floor(x/24);x-=u*24;let m=Math.floor(u/365);if(u-=m*365,e!=null&&e.millis||(h=0),a!=null&&u+x+f+d+h===0)return a;let j=[];if(t!=="long"?j=[m>0?m.toFixed(0):"",u>0?u.toFixed(0):"",x>0||t==="short"?x.toFixed(0):"",f>0||t==="short"?f.toFixed(0):"",(d+h/1e3).toFixed(!(e!=null&&e.millis)||t==="tiny"&&h===0?0:3)].map(b=>t==="short"&&(b.length===1||b.indexOf(".")===1)?"0"+b:b):j=[[m,"year"],[u,"day"],[x,"hour"],[f,"minute"],[d,"second",m+u+x+f===0,h]].map(([b,L,B=!1,O=0])=>b>0||O>0||B&&b===0?b.toString()+(O>0?"."+O.toString():"")+" "+L+(b===1?"":"s"):""),j=j.filter(b=>!!b),j.length>2){const b=j.pop();j=[j.join(n),b]}let S=j.join(r)+(l?" "+l:"");return S&&(e!=null&&e.alwaysShowSign)&&s>=0&&t!=="long"&&!"+-".includes(S[0])&&(S="+"+S),S};T.word=function(s,e){return s||(s=(Math.abs(Math.abs((e==null?void 0:e.count)??0)-1)<=((e==null?void 0:e.tolerance)??.001)?e==null?void 0:e.singularName:e==null?void 0:e.pluralName)??(e==null?void 0:e.name)),(e==null?void 0:e.condition)??!0?!s&&!((e==null?void 0:e.allowEmpties)??!1)?"":(e==null?void 0:e.capitalize)??!0?(s??"").replace(/([a-z])([A-Z]|_\S)/g,(t,n,r)=>`${n} ${r.slice(-1)}`).replace(/(?:^|\s)\w(?=\w)/g,t=>t.toUpperCase()):s??"":""};function vt({car:s,track:e}){const t=A.useHook(),n=v.useRef(null),r=v.useMemo(()=>i.jsx("canvas",{ref:n,width:`${q}px`,height:`${q}px`}),[]);if(n.current){const o=n.current.getContext("2d",{alpha:!1});o.clearRect(0,0,q,q),o.translate(-$(s.position.x-q/2,0,e.width-q),-$(s.position.y-q/2,0,e.height-q)),e.render(o),s.render(o,!1,!0),o.resetTransform()}const a=s.score;return i.jsx(ne,{children:i.jsxs(C,{class:"ion-align-items-start ion-justify-content-between",children:[i.jsx(g,{size:"12",children:i.jsxs(M,{children:[i.jsx(D,{children:s.name}),i.jsx(P,{slot:"end",children:s.laps>=3?"Won":s.collided?"Inactive":"Active"}),i.jsxs(P,{slot:"end",children:[T(s.odometer,{prec:0}),"px"]}),i.jsxs(P,{slot:"end",children:[T(a.time,{prec:1}),"s"]}),i.jsxs(P,{slot:"end",children:[T(s.laps,{prec:0})," laps"]})]})}),i.jsxs(g,{size:"4",children:[i.jsx(M,{children:i.jsx(D,{children:"Sensor Readings:"})}),s.sensorReadings&&s.sensorReadings.length==t.length&&t.map((o,l)=>i.jsx(M,{children:i.jsxs(P,{slot:"end",children:[i.jsxs("span",{children:["∠",T(o.angle*(180/Math.PI),{prec:0}),"°"]})," ",i.jsxs("span",{children:["⟩",T(o.range,{prec:0}),"px"]})," ",i.jsxs("span",{children:["⇒ ",T(s.sensorReadings[l],{prec:3})]})]})},l))]}),i.jsxs(g,{size:"4",children:[i.jsx(M,{children:i.jsx(D,{children:"Control Outputs:"})}),i.jsxs(M,{children:[i.jsx(D,{children:"Acceleration"}),i.jsx(P,{slot:"end",children:T(s.acceleration,{prec:3})})]}),i.jsxs(M,{children:[i.jsx(D,{children:"Steering"}),i.jsx(P,{slot:"end",children:T(s.steering,{prec:3})})]})]}),i.jsxs(g,{size:"4",class:"ion-text-end",children:[i.jsxs(M,{children:["Score:",i.jsx(P,{slot:"end",children:T(a.score,{prec:2})})]}),r]})]})})}const q=200,bt=Fe,It=Be,Tt=Ue,Me=rt;function St({icon:s,src:e,...t}){const n=s||e||"";return n.startsWith("data:")?i.jsx(U,{icon:n,...t}):n.includes("/")||n.includes(".")?i.jsx(U,{src:n,...t}):Me[n]?i.jsx(U,{icon:Me[n],...t}):i.jsx(U,{icon:at,...t})}function G(){const s=G.useTabs(),e=window.location.search||"";return i.jsx(We,{children:i.jsxs(It,{children:[i.jsxs(qe,{children:[s.map(t=>i.jsx(Ie,{exact:!0,path:`/${t.path}`,children:i.jsxs(Ge,{children:[i.jsx(Ye,{children:i.jsxs(Je,{children:[i.jsx(Ze,{slot:"start",children:t.title||t.path}),i.jsxs(P,{slot:"end",color:"success",children:["© 2025  ",i.jsx("a",{href:"https://github.com/lepouya",target:"_blank",style:{textDecoration:"none"},children:"@lepouya"})]}),i.jsx(P,{slot:"end",color:"light",children:i.jsx("a",{href:"https://github.com/lepouya/idle-self-driving",target:"_blank",style:{textDecoration:"none"},children:i.jsx("small",{children:"view source"})})})]})}),i.jsx(Ce,{id:"tab-contents",children:t.content}),s.filter(n=>n.alwaysMounted&&n!==t).map(n=>i.jsx(v.Fragment,{children:n.content},`page-${n.path}`))]})},`tab-${t.path}`)),s.filter(t=>!!t.from).map(t=>i.jsx(Ie,{exact:!0,path:t.from,children:i.jsx(Ke,{to:`/${t.path}${e}`})},`default-tab-${t.path}`))]}),i.jsx(Qe,{slot:"bottom",children:s.map(t=>(t.icon||t.label)&&i.jsxs(Tt,{tab:t.path,href:`/${t.path}${e}`,children:[t.icon&&i.jsx(St,{"aria-hidden":"true",icon:t.icon}),t.label&&i.jsx(D,{children:t.label})]},`tab-button-${t.path}`))})]})})}const ee=te({});G.register=function(s){ee.get()[s.path]=s,ee.signal()};G.unregister=function(s){delete ee.get()[typeof s=="string"?s:s.path],ee.signal()};G.useTabs=function(){const s=ee.useHook();return Object.values(s)};function ue(){var h,f,x;const s=p.useHook(),e=v.useRef(null),t=W.useHook(),n=N.useHook(),[r,a]=v.useState(void 0),o=t[s.currentTrack];v.useEffect(()=>{N.nextGeneration(o,!1)},[o]),v.useEffect(()=>{var u;if(e.current){const m=e.current.getContext("2d",{alpha:!1});s.renderSensors?(u=n[0])==null||u.renderSensors().then(j=>{m.clearRect(0,0,s.trackWidth,s.trackHeight),m.resetTransform(),m.drawImage(j.canvas,0,0)}):(o.render(m),N.renderAll(m))}},[s.currentTrack,e.current,s.lastRender]),v.useEffect(()=>{if(!e.current)return;const u=j=>{const S=e.current.getBoundingClientRect(),b=j.clientX-S.left,L=j.clientY-S.top,B=Object.values(N.registry.get()).sort((O,k)=>k.score.score-O.score.score);for(const O of B)if(O.isClickedOn(b,L)){a(O);return}a(void 0)},m=e.current;return m.addEventListener("click",u),()=>{m.removeEventListener("click",u)}},[e.current,a]),v.useEffect(()=>{const u=(r==null?void 0:r.name)||"";a(void 0);for(const m of n)if(m.name===u){a(m);return}},[o,n[0]]);const l=Math.max(...n.map(u=>u.score.score))||0,d=n.filter(u=>!u.collided).length;return i.jsxs(ne,{children:[i.jsxs(C,{children:[i.jsx(g,{size:"8",children:i.jsx("canvas",{ref:e,width:`${s.trackWidth}px`,height:`${s.trackHeight}px`})}),i.jsxs(g,{size:"4",children:[i.jsxs(M,{children:[i.jsxs(D,{children:["Iteration ",s.numIterations]}),i.jsx(H,{slot:"end",expand:"block",title:"Skip to next iteration",onClick:()=>N.nextGeneration(o,!0),children:i.jsx(U,{icon:$e})}),i.jsx(H,{slot:"end",expand:"block",color:s.autoAdvance?"primary":"medium",title:"Toggle auto-advance at the end of each iteration",onClick:()=>s.set({autoAdvance:!s.autoAdvance}),children:i.jsx(U,{icon:Ae})}),i.jsx(H,{slot:"end",expand:"block",color:s.globalPaused?"medium":"primary",title:s.globalPaused?"Resume":"Pause",onClick:()=>s.set({globalPaused:!s.globalPaused}),children:i.jsx(U,{icon:s.globalPaused?ot:ct})})]}),i.jsxs(M,{children:[i.jsx(D,{children:"Leader Score"}),i.jsx(P,{slot:"end",children:T(l,{prec:2})})]}),i.jsx(M,{children:i.jsx(Xe,{label:"Track Selection",interface:"alert",value:s.currentTrack,onIonChange:u=>{s.set({currentTrack:u.detail.value})},children:Object.keys(t).map(u=>i.jsx(Ve,{value:u,children:u},u))})}),i.jsxs(M,{children:[i.jsxs(D,{children:["Best Score on ",s.currentTrack," Track"]}),i.jsx(P,{slot:"end",children:T(Math.max(l,((h=s.sotaScore[s.currentTrack])==null?void 0:h.score)||0),{prec:2})})]}),i.jsx(M,{children:i.jsx(D,{children:" "})}),i.jsxs(M,{children:[i.jsx(D,{children:"Active Cars"}),i.jsxs(P,{slot:"end",children:[d,"/",n.length]})]}),i.jsxs(M,{children:[i.jsx(D,{children:"Simulation Speed"}),i.jsxs(P,{slot:"end",children:[T(((f=s.execution.tick)==null?void 0:f.tps)||0)," tps"]})]}),i.jsxs(M,{children:[i.jsx(D,{children:"Rendering Speed"}),i.jsxs(P,{slot:"end",children:[T(((x=s.execution.tick)==null?void 0:x.fps)||0)," fps"]})]}),i.jsx(M,{children:i.jsx(Te,{checked:s.manualControl,onIonChange:u=>{s.set({manualControl:u.detail.checked}),N.nextGeneration(o,!1)},children:"Manually Controlled Car"})}),i.jsx(M,{children:i.jsx(Te,{checked:!s.helpDismissed,onIonChange:u=>{s.set({helpDismissed:!u.detail.checked})},children:"Show Help/About Page"})}),i.jsx(M,{children:i.jsx(D,{children:" "})}),i.jsxs(M,{children:[i.jsx(D,{children:r?"Selected car:":"Click on a car to visualize its state"}),r&&i.jsx(P,{slot:"end",children:r.name})]})]})]}),i.jsxs(C,{children:[i.jsx(g,{size:"5",children:i.jsx(pe,{label:"Driving events",labelPlacement:"floating",fill:"outline",placeholder:"Car Events are logged here",rows:15,value:N.events.join(`
`),readonly:!0})}),i.jsx(g,{size:"7",children:r&&i.jsx(vt,{car:r,track:o})})]})]})}ue.init=()=>{G.register({path:"driving",content:i.jsx(ue,{}),icon:"speedometerOutline",label:"Driving",title:"Idle Self Driving",from:"/"})};function fe(){const s=p.useHook();return s.helpDismissed?null:i.jsx(_e,{trigger:"tab-contents",isOpen:!s.helpDismissed,showBackdrop:!0,side:"start",alignment:"start",onDidDismiss:()=>s.set({helpDismissed:!0}),children:i.jsx(Mt,{})})}function Mt(){const s=p.useHook(),e=v.useRef(null),[t,n]=v.useState(),[r,a]=v.useState();return v.useEffect(()=>{(async()=>{const l=new Ct("Demo Track"),d=new N("","#33eeee",0,!1);d.visualizeSensors=!0,await Promise.all([l.fetchImageData(),d.fetchImageData()]),d.placeOnTrack(l),d.position={x:100,y:100},d.tick(0),await d.renderSensors(),n(l),a(d)})()},[n,a]),v.useEffect(()=>{if(!e.current||!r||!r.canvas||!t||!t.canvas)return;const o=s.lastRender/1e3%8*45*(Math.PI/180);r.position={x:100+50*Math.cos(o),y:100+40*Math.sin(o)},r.angle=o+Math.PI/2,r.tick(0);const l=e.current.getContext("2d",{alpha:!1});t.render(l),r.render(l)},[s.lastRender,e.current,r,t]),i.jsxs(Ce,{id:"help-page",class:"ion-padding",children:[i.jsxs(ne,{fixed:!0,children:[i.jsx(C,{children:i.jsx(g,{children:i.jsx("h1",{children:"About: Idle Self Driving"})})}),i.jsx(C,{children:i.jsx(g,{children:i.jsx("p",{children:"This is a simple demonstration of self-driving cars receiving sensory information from their surroundings and controlling their acceleration and steering using a simple neural network."})})}),i.jsxs(C,{children:[i.jsx(g,{size:"4",children:i.jsx("canvas",{ref:e,width:`${(t==null?void 0:t.width)||1}px`,height:`${(t==null?void 0:t.height)||1}px`,style:{margin:"auto",display:"block"}})}),i.jsxs(g,{size:"8",children:[i.jsx("p",{children:"Each car has 5 sensor inputs in front of it. The reading values are between 0 and 1 indicating how far the car is from the edges of the track"}),i.jsx("p",{children:"The network outputs two values between -1 and 1. One for the acceleration of the car (negative means breaking), and the other for steering (negative for left, positive for right)."}),i.jsx("p",{children:"A simple simulation calculates the velocity and the angle of the car. Some basic friction is also calculated for speed and steering, but I didn't bother with drifting or skidding. At least not for now."})]})]}),i.jsx(C,{children:i.jsxs(g,{children:[i.jsx("p",{children:'The cars can "lose" if they hit the edges of the track. There are also some criteria for crossing the finish line in wrong direction or backtracking on the track. There is no collision between the cars, so you can think of this as being in separate tracks or ghosting.'}),i.jsx("p",{children:'A car "wins" if it successfully laps the track 3 times. The scoring is based on the distance travelled and the speed of the car. The faster a car finishes the laps the better it scores. And the further it gets before losing the better it scores.'}),i.jsx("p",{children:"At the beginning of each iteration, 10 new cars are generated based on the global best on the track and the winner of the last track. Some random choices are also made. The further we are in the training, the less random variations there are between cars"}),i.jsxs("p",{children:["The ",i.jsx(U,{icon:$e})," button will start a new iteration, even if there are still cars racing in the current track. Use the ",i.jsx(U,{icon:Ae})," ","button to automatically advance to the next iteration after all cars have finished."]})]})}),i.jsx(C,{children:i.jsxs(g,{children:[i.jsx("p",{children:'You can also change the track the race is taking place on the right side panel. I recommend moving on to the "Advanced" track once you have trained a car that can lap around the "Basic" track. It might take a few more iterations before you have a car that can make the tight corners on the "Advanced" track.'}),i.jsx("p",{children:'There is also an "Oval" track that you can use for fine-tuning the speed of the track navigation, but be mindful that staying on it too long might cause your model to "forget" how to turn left. This is not a commentary on NASCAR™. I promise.'}),i.jsx("p",{children:'Finally, you can put all of the learnings to the test on the "Curvy" track to test both steering abilities and the speed choices of your model.'})]})}),i.jsx(C,{children:i.jsxs(g,{children:["Pro tips:",i.jsxs("ul",{children:[i.jsx("li",{children:'You can save / load / reset the state on the "Settings" tab below. Using import/export features lets you share your models'}),i.jsx("li",{children:"Click on a car on the race track to see visualization of its sensor inputs and control outputs."}),i.jsx("li",{children:"The ability to customize # of sensors, their angles, and ranges are there, but I haven't made the UI for it yet. You can still do it by mocking around in the saved settings, or just get the source code: the link is on top right. Coming later."}),i.jsx("li",{children:"Ability to change the # of layers and neurons in the net is also there, but doesn't have a UI either. You can use the same tricks above to play with it. Or to view your current SOTA."}),i.jsx("li",{children:'If you want your save files in plain text (json) instead of base64, add "?debug" to the URL and you get a bunch of new feature'})]})]})})]}),i.jsx(H,{onClick:()=>s.set({helpDismissed:!0}),children:"Close"})]})}class Ct extends W{constructor(){super(...arguments);c(this,"width",200);c(this,"height",200)}get path(){return["M 0 100 h 200"]}get roadThickness(){return 120}get laneMarkingThickness(){return 3}get startingPoint(){return{x:25,y:100}}get startingDirection(){return{x:1,y:0}}}fe.init=()=>{G.register({path:"help",content:i.jsx(fe,{}),alwaysMounted:!0})};function me(){return i.jsxs(ne,{children:[i.jsx($t,{}),i.jsx(At,{}),i.jsx(Pt,{}),i.jsx(Rt,{})]})}me.init=()=>{G.register({path:"settings",content:i.jsx(me,{}),icon:"settingsOutline",label:"Settings",title:"Settings"})};function $t(){const s=p.useHook(),[e,t]=v.useState("");return i.jsxs(re,{children:[i.jsx(ae,{children:i.jsx(oe,{children:i.jsx(C,{children:i.jsx(g,{size:"12",className:"ion-text-center",children:i.jsx(X,{children:"Data"})})})})}),i.jsxs(ce,{children:[i.jsxs(C,{children:[i.jsxs(g,{size:"12",children:["Started"," ",T.time(s.lastTick??0,{epoch:s.lastReset})]}),i.jsxs(g,{size:"12",children:["This session started"," ",T.time(s.lastTick??0,{epoch:s.lastLoaded})]}),i.jsxs(g,{size:"12",children:["Last saved"," ",T.time(s.lastTick??0,{epoch:s.lastSaved})]})]}),i.jsxs(C,{children:[i.jsx(g,{size:"6",children:i.jsx(H,{onClick:()=>{p.load().then(()=>p.save()).then(ie)},expand:"block",children:"Load"})}),i.jsx(g,{size:"6",children:i.jsx(H,{onClick:()=>p.save(),expand:"block",children:"Save"})}),i.jsx(g,{size:"6",children:i.jsx(H,{onClick:Et,expand:"block",children:"Load from File"})}),i.jsx(g,{size:"6",children:i.jsx(H,{onClick:Dt,expand:"block",children:"Save to File"})}),i.jsx(g,{size:"6",children:i.jsx(H,{onClick:()=>{s.load(ke(e)),p.save().then(ie)},expand:"block",children:"Import Text"})}),i.jsx(g,{size:"6",children:i.jsx(H,{onClick:()=>t(he(s.save(),p.isDebug())),expand:"block",children:"Export Text"})}),i.jsx(g,{size:"12",children:i.jsx(pe,{label:"Data for import/export",labelPlacement:"floating",fill:"outline",rows:5,autoGrow:!0,value:e,onIonInput:n=>t(n.detail.value??"")})})]})]})]})}function At(){const s=p.useHook(),[e,t]=v.useState(s.ticksPerSec),[n,r]=v.useState(s.rendersPerSec),[a,o]=v.useState(s.saveFrequencySecs);return v.useEffect(()=>{t(s.ticksPerSec)},[s.ticksPerSec]),v.useEffect(()=>{r(s.rendersPerSec)},[s.rendersPerSec]),v.useEffect(()=>{o(s.saveFrequencySecs)},[s.saveFrequencySecs]),i.jsxs(re,{children:[i.jsx(ae,{children:i.jsx(oe,{children:i.jsx(C,{children:i.jsx(g,{size:"12",className:"ion-text-center",children:i.jsx(X,{children:"Advanced Settings"})})})})}),i.jsxs(ce,{children:[i.jsxs(C,{children:[i.jsx(g,{size:"12",children:"If you are having performance issues, increase the time between updates. Faster updating frequncies lead to better experience but might use a lot of CPU."}),i.jsx(g,{size:"6",className:"ion-text-right",children:"Updating frequency:"}),i.jsxs(g,{size:"6",className:"ion-text-center",children:[Math.floor(1e3/s.ticksPerSec),"ms"]}),i.jsx(g,{size:"6"}),i.jsx(g,{size:"6",children:i.jsx(de,{min:6,max:200,step:1,pin:!0,pinFormatter:l=>`${Math.floor(1e3/l)}ms`,value:e,onIonInput:l=>t(l.detail.value),onIonChange:l=>{s.set({ticksPerSec:l.detail.value})},className:"ion-no-padding"})}),i.jsx(g,{size:"6",className:"ion-text-right",children:"Rendering frequency:"}),i.jsxs(g,{size:"6",className:"ion-text-center",children:[Math.floor(1e3/s.rendersPerSec),"ms"]}),i.jsx(g,{size:"6"}),i.jsx(g,{size:"6",children:i.jsx(de,{min:1,max:60,step:1,pin:!0,pinFormatter:l=>`${Math.floor(1e3/l)}ms`,value:n,onIonInput:l=>r(l.detail.value),onIonChange:l=>{s.set({rendersPerSec:l.detail.value})},className:"ion-no-padding"})})]}),i.jsxs(C,{children:[i.jsx(g,{size:"12",children:"Change how often the session is saved in the background. More frequent saving leads to faster backups, but increases CPU and I/O usage"}),i.jsx(g,{size:"6",className:"ion-text-right",children:"Saving frequency:"}),i.jsx(g,{size:"6",className:"ion-text-center",children:T.time(1e3*s.saveFrequencySecs,{ago:""})}),i.jsx(g,{size:"6"}),i.jsx(g,{size:"6",children:i.jsx(de,{min:1,max:60,step:1,pin:!0,pinFormatter:l=>T.time(1e3*(300/l),{ago:"",len:"tiny"}).replace(":","m:")+"s",value:300/a,onIonInput:l=>o(300/l.detail.value),onIonChange:l=>{s.set({saveFrequencySecs:300/l.detail.value})},className:"ion-no-padding"})})]})]})]})}function Pt(){const[s,e]=v.useState(!1);function t(){s&&(e(!1),p.reset(),z.clear().then(ie))}return i.jsxs(re,{children:[i.jsx(ae,{children:i.jsx(oe,{children:i.jsx(C,{children:i.jsx(g,{size:"12",className:"ion-text-center",children:i.jsx(X,{children:"Reset"})})})})}),i.jsx(ce,{children:i.jsxs(C,{children:[i.jsx(g,{size:"12",children:i.jsx(X,{color:"danger",children:"WARNING: this will completely reset your settings and delete all saved progress. Only use this if you want to restart from the beginning, or if something in the settings is so messed up that it is unusable."})}),i.jsx(g,{size:"12",children:i.jsx(et,{justify:"end",checked:s,onIonChange:()=>e(n=>!n),children:"I understand what this means and still want to reset"})}),i.jsx(g,{size:"12",class:"ion-text-right",children:i.jsx(H,{onClick:t,disabled:!s,color:s?"danger":"medium",children:"Reset everything"})})]})})]})}function Rt(){const s=p.useHook();return p.isDebug()&&i.jsxs(re,{children:[i.jsx(ae,{children:i.jsx(oe,{children:i.jsx(C,{children:i.jsx(g,{size:"12",className:"ion-text-center",children:i.jsx(X,{children:"Debug Context"})})})})}),i.jsx(ce,{children:i.jsx(C,{children:i.jsx(g,{size:"12",children:i.jsx(pe,{autoGrow:!0,readonly:!0,value:he(s,!0)})})})})]})}function Dt(){const s=p.singleton,e="idle-self-driving".replace(/\W/g,"_"),t="0.9.1".replace(/\W/g,"_"),n=new Date().toISOString().replace(/\D/g," ").trim().replace(/\D/g,"-"),r=`${e}-v${t}-${n}`,a=he(s.save(),p.isDebug()),o=new Blob([a],{type:"text/plain"}),l=URL.createObjectURL(o),d=document.createElement("a");d.href=l,d.download=r,d.click(),URL.revokeObjectURL(l)}function Et(){const s=document.createElement("input");s.type="file",s.addEventListener("change",function(e){const t=e.target.files;if(!t||t.length===0||!t[0])return;const n=new FileReader;n.onload=function(r){var l;const a=(l=r.target)==null?void 0:l.result;if(!a||typeof a!="string")return;const o=p.singleton;o.load(ke(a)),o.tick(void 0,"load"),p.save().then(ie)},n.readAsText(t[0])},!1),s.click()}function ie(){tt().push("#/"),window.location.reload()}function xe(){const s=p.useHook();return v.useEffect(()=>(E.addEventListeners(),z.initialize(),()=>E.removeEventListeners()),[]),v.useEffect(()=>(p.addTickTimer(),()=>p.removeTickTimer()),[s.ticksPerSec]),null}xe.initialize=async function(){await z.initialize(),await p.load(),await Promise.all([ue.init(),me.init(),fe.init()]),await Promise.all([W.loadAll(),A.loadAll()])};st();window.addEventListener("load",async()=>{const s=document.createElement("div");s.id="root",document.body.appendChild(s);const e=it.createRoot(s);await xe.initialize(),e.render(i.jsx(v.StrictMode,{children:i.jsxs(bt,{children:[i.jsx(xe,{}),i.jsx(G,{})]})}))},!1);
