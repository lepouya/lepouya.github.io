var Oe=Object.defineProperty;var ze=(s,e,t)=>e in s?Oe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>ze(s,typeof e!="symbol"?e+"":e,t);import{r as b,u as Le,a as Ne,I as He,b as Fe,c as Be,j as i,d as F,e as Ue,f as We,R as ve,g as qe,h as Ge,i as Je,k as Ye,l as be,m as Me,n as Ke,o as Ze,p as D,q as fe,s as T,t as u,v as E,w as O,x as Qe,y as Xe,z as Ie,A as me,B as Ve,C as se,D as ie,E as ne,F as Z,G as re,H as ce,J as _e,K as et,L as tt,M as st}from"./react-BEuL03O2.js";import{S as it}from"./ionic-Bb5Q-mFB.js";import{I as nt,b as rt,p as $e,r as Ae,a as at,c as ot}from"./ionicons-CiEm7yBE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();function $(s=0,e=0,t=1){return isNaN(s)||s<e?e:s>t?t:s}class ct extends Error{}class Te extends Error{}class lt{constructor(e,t){c(this,"canvas");c(this,"options");this.canvas=e,this.options=t}get dataURL(){return this.canvas.toDataURL(this.options.format,this.options.quality)}get blob(){return new Promise((e,t)=>this.canvas.toBlob(n=>n?e(n):t(new Te),this.options.format,this.options.quality))}getPixels(e,t,n,r){var y,v;const a=this.canvas.width,o=this.canvas.height,h=ee(e,0,a-1),d=ee(t,0,o-1),l=ee(n,1,a-h),g=ee(r,1,o-d),f=(v=(y=this.canvas)==null?void 0:y.getContext("2d",{alpha:!1}))==null?void 0:v.getImageData(h,d,l,g);if(!f)throw new Te;return{buffer:new Uint32Array(f.data.buffer),startX:h-e,startY:d-t,width:l,height:g}}}async function K(s,e){var h;const t=Object.assign({},dt,e),n=[...s||[],...(t==null?void 0:t.sources)||[]],r=await Promise.all(n.map(d=>ht(d,t)));let a=t.reuse instanceof HTMLCanvasElement?t.reuse:(h=t.reuse)==null?void 0:h.canvas;a||(a=window.document.createElement("canvas")),a.width=t.width||Math.max(...r.map(([d])=>d.width)),a.height=t.height||Math.max(...r.map(([d])=>d.height)),a.className=[...Array.isArray(t.className)?t.className:[t.className],"composed-image"].join(" "),t.style&&Object.assign(a.style,t.style);const o=a.getContext("2d");t.clear&&o.clearRect(0,0,a.width,a.height);for(let[d,l]of r){o.save();let g=A(l.crop,0,"x")||0,f=A(l.crop,1,"y")||0,w=A(l.crop,2,"w")||d.width,y=A(l.crop,3,"h")||d.height,v=A(l.position,0,"x")||0,S=A(l.position,1,"y")||0,I=(A(l.stretch,0,"sx")||1)*w,z=(A(l.stretch,1,"sy")||1)*y,W=(A(l.rotate,2,"a")||0)*(Math.PI/180),H=typeof l.rotate=="number"?void 0:l.rotate,x=(A(H,0,"x")??.5)*I+v,L=(A(H,1,"y")??.5)*z+S,pe=A(l.scale,2,"sx")??1,ke=A(l.scale,3,"sy")??1,we=typeof l.scale=="number"?void 0:l.scale,ye=(A(we,0,"x")??.5)*I+v,je=(A(we,1,"y")??.5)*z+S;o.globalAlpha=l.opacity??1,o.globalCompositeOperation=l.composition??"source-over",o.imageSmoothingEnabled=l.smoothing!==!1&&l.smoothing!=="disabled",o.imageSmoothingQuality=l.smoothing==="medium"||l.smoothing==="high"?l.smoothing:"low",Array.isArray(l.filter)?o.filter=l.filter.join(" "):l.filter&&(o.filter=l.filter),o.filter||(o.filter="none"),o.resetTransform(),W!==0&&(o.translate(x,L),o.rotate(W),o.translate(-x,-L)),(pe!==1||ke!==1)&&(o.translate(ye,je),o.scale(pe,ke),o.translate(-ye,-je)),o.imageSmoothingEnabled||(g=~~g,f=~~f,w=~~w,y=~~y,v=~~v,S=~~S,I=~~I,z=~~z),o.drawImage(d,g,f,w,y,v,S,I,z),o.restore()}return new lt(a,t)}function ht(s,e){return new Promise((t,n)=>{var o,h,d,l;const r=typeof s=="string"?{src:s}:s;r.src=(r.src||"").trim(),!r.src||r.src==="transparent"?r.src=gt:r.src.startsWith("plain:")?r.src=ut.replace("{color}",encodeURIComponent(r.src.slice(6).trim())).replace("{width}",((o=e==null?void 0:e.width)==null?void 0:o.toString())||"100%").replace("{height}",((h=e==null?void 0:e.height)==null?void 0:h.toString())||"100%"):r.src.startsWith("<svg")&&(r.src.includes("xmlns=")||(r.src=r.src.replace("<svg",'<svg xmlns="http://www.w3.org/2000/svg"')),r.src="data:image/svg+xml;utf8,"+encodeURIComponent(r.src.replace("{width}",((d=e==null?void 0:e.width)==null?void 0:d.toString())||"100%").replace("{height}",((l=e==null?void 0:e.height)==null?void 0:l.toString())||"100%")));const a=new Image;a.onerror=()=>n(new ct),a.onload=()=>t([a,r]),a.crossOrigin="anonymous",a.src=r.src})}const dt={format:"image/png",quality:.92},gt="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",ut='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1" preserveAspectRatio="none"     width="{width}" height="{height}">  <rect x="0" y="0" width="1" height="1" fill="{color}" /></svg>';function A(s,...e){let t;if(!s||typeof s=="number")t=s??void 0;else if(Array.isArray(s)){for(let n of e)if(typeof n=="string"&&(n=parseInt(n)),typeof n=="number"&&isFinite(n)){const r=s[n];if(r!=null&&typeof r=="number"){t=r;break}}}else if(typeof s=="object"){for(let n of e)if(typeof n=="string"||typeof n=="number"){const r=s[n];if(r!=null&&typeof r=="number"){t=r;break}}}for(let n of e)n&&typeof n=="object"&&(n.def!=null&&t==null&&(t=n.def),n.min!=null&&t!=null&&(t=Math.max(t,n.min)),n.max!=null&&t!=null&&(t=Math.min(t,n.max)));return t}function ee(s=0,e=0,t=1){return isNaN(s)||s<e?~~e:s>t?~~t:~~s}function _(s){const e={};function t(){return typeof s=="function"?s():s}function n(){return Date.now().toString(36)+Math.random().toString(36).slice(1)}function r(l,g){const f=g||n();return e[f]=l,f}function a(l){delete e[l]}function o(){return e}function h(){const l={ref:t()};Object.values(e).forEach(g=>g(l))}function d(){const[l,g]=b.useState(n),[f,w]=b.useState(()=>({ref:t()}));return b.useEffect(()=>{const y=r(w,l);return g(y),()=>{a(l),a(y)}},[l]),Le(()=>{const y=r(w,l);g(y)},[l]),Ne(()=>{a(l)},[l]),f.ref}return{useHook:d,signal:h,register:r,unregister:a,getRegistry:o,get:t}}function ae(s){if(ae.skipEncoding||!s)return s;const e=s.startsWith(".."),t=(e?s:Math.random().toString(36)).substring(2,10);return(e?"":".."+t)+(e?s.slice(10):s).split("").map(n=>n.charCodeAt(0)).map((n,r)=>String.fromCharCode(n^t.charCodeAt(r%8))).join("")}ae.skipEncoding=!1;function Ce(s,e){const t=[];function n(r,a){if(!(r&&r.startsWith("_")))return!a||typeof a!="object"||Array.isArray(a)?a:a instanceof Date?a.toJSON():Object.keys(a).length===0||t.includes(a)?void 0:(t.push(a),a)}return JSON.stringify(s,n,e)}function oe(s,e=!1){const t=Ce(s,e?2:void 0);return e?t:window.btoa(ae(encodeURIComponent(t)))}function xe(s){if(!s||typeof s!="string")return s??void 0;try{const e=JSON.parse(decodeURIComponent(ae(window.atob(s))));if(e)return e}catch{}try{const e=JSON.parse(s);if(e)return e}catch{}return s}const q={db:void 0};function R(){return R.initialize(),q.db}R.initialize=async function(){return q.db||(q.db=new it,q.db=await q.db.create()),q.db};R.write=async function(s,e,t=!1){const n=oe(e,t),r=await R.initialize();return await(r==null?void 0:r.set(s,n))};R.read=async function(s){const e=await R.initialize(),t=await(e==null?void 0:e.get(s));return xe(t)};R.clear=async function(){const s=await R.initialize();await(s==null?void 0:s.clear())};function C(s,e){C.register(s,e)}C.register=function(s,e){s=s.toLowerCase().replace(/\W/g,""),G[s]??(G[s]=[]),G[s].includes(e)||G[s].push(e)};C.addEventListeners=function(){document.addEventListener("keydown",Pe),document.addEventListener("keyup",De),Re()};C.removeEventListeners=function(){document.removeEventListener("keydown",Pe),document.removeEventListener("keyup",De),Re()};C.test=function(s){return Q[s.toLowerCase().replace(/\W/g,"")]??!1};C.some=function(...s){return s.some(C.test)};C.all=function(...s){return s.every(C.test)};const ft=["TEXTAREA","INPUT"],G={},Q={};function Pe(s){if(Ee(s.target))return;const e=s.key.toLowerCase().replace(/\W/g,"");Q[e]=!0;const t=G[e];t&&t.length>0&&t.forEach(n=>{n(s)&&(s.preventDefault(),s.stopPropagation())})}function De(s){if(Ee(s.target))return;const e=s.key.toLowerCase().replace(/\W/g,"");Q[e]=!1}function Re(){Object.keys(Q).forEach(s=>Q[s]=!1)}function Ee(s){try{return s&&ft.includes(s.tagName.toUpperCase())}catch{return!1}}function mt(s=0,e=1){const t=1-Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*n)*e+s}class X{constructor(e){this.config=e,this.validate(),this.regularize()}static init(e,t,n){if(!e)throw new Error("Invalid input count");if(!t)throw new Error("Invalid output count");n||(n=[]);const r=[];for(let a=0;a<n.length+1;a++){const o=a===0?e:n[a-1],h=a===n.length?t:n[a],d=[];for(let l=0;l<h;l++){const g=[];for(let f=0;f<o+1;f++)g.push(0);d.push(g)}r.push(d)}return new X({input:e,output:t,hidden:n,weights:r})}validate(){const{input:e,hidden:t,output:n,weights:r}=this.config;if(e<1)throw new Error("Invalid input count");if(t.length<0)throw new Error("Invalid hidden layer count");if(n<1)throw new Error("Invalid output count");if(r.length!==t.length+1)throw new Error("Invalid weight count");for(let a=0;a<r.length;a++){const o=a===0?e:t[a-1],h=a===t.length?n:t[a];if(r[a].length!==h)throw new Error(`Invalid row count for weights layer ${a}`);for(let d=0;d<r[a].length;d++)if(r[a][d].length!==o+1)throw new Error(`Invalid col count for weights layer ${a} neuron ${d}`)}}regularize(){const e=this.config.weights,t=2;for(let n=0;n<e.length;n++)for(let r=0;r<e[n].length;r++)for(let a=0;a<e[n][r].length;a++)e[n][r][a]=$(e[n][r][a],-2,t)}eval(e){const t=this.config.weights;let n=e;for(let r=0;r<t.length;r++){let a=[];for(let o=0;o<t[r].length;o++){let h=t[r][o][n.length-1];for(let d=0;d<n.length-1;d++)h+=n[d]*t[r][o][d];a.push(this.activation(h))}n=a}return n}activation(e){return e<-1?-1:e>1?1:e}randomStep(e){return new X({...this.config,weights:this.config.weights.map(t=>t.map(n=>n.map(r=>mt(r,e))))})}}const p=class p{constructor(e,t="",n=.5,r=!0){c(this,"renderImage");c(this,"sensorImage");c(this,"width",m.singleton.carWidth);c(this,"height",m.singleton.carHeight);c(this,"track",null);c(this,"position",{x:0,y:0});c(this,"angle",0);c(this,"speed",0);c(this,"steering",0);c(this,"acceleration",0);c(this,"odometer",0);c(this,"laps",0);c(this,"inCrossing",!1);c(this,"totalTicks",0);c(this,"startTime",0);c(this,"endTime",0);c(this,"collided",!1);c(this,"pastTracking",[]);c(this,"sensorsReady",!0);c(this,"sensorReadingTime",0);c(this,"sensorReadings",[]);c(this,"visualizeSensors",!1);c(this,"net",null);if(this.name=e,this.color=t,this.fudgeFactor=n,!t){const a=[32,64,128].map(o=>$(~~(Math.random()*o*2),0,255));this.color="#"+a.map(o=>o.toString(16).padStart(2,"0")).join("")}e&&r&&(p.registry.get()[e]=this)}static useHook(){const e=p.registry.useHook();return Object.values(e)}get mask(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        rx="${this.width/4}"
        ry="${this.height/4}"
        fill="${M.color.vehicle}"
        shape-rendering="crispEdges"
      />`,"</svg>"].join("")}get image(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        rx="${this.width/4}"
        ry="${this.height/4}"
        fill="${this.laps>=3?"green":this.collided?"red":this.color}"
      />`,[[0,0],[this.width*3/4,0],[this.width*3/4,this.height*3/4],[0,this.height*3/4]].map(([e,t])=>`<rect
            x="${e}"
            y="${t}"
            width="${this.width/4}"
            height="${this.height/4}"
            rx="${this.width/8}"
            ry="${this.height/8}"
            fill="black"
          />`),"</svg>"].join("")}get canvas(){var e;return(e=this.renderImage)==null?void 0:e.canvas}async fetchImageData(){return this.renderImage=await K([],{reuse:this.renderImage,clear:!0,sources:[{src:this.image,opacity:this.net?.666:1}],width:this.width,height:this.height}),this.renderImage}get score(){const e=Date.now(),t=this.odometer/Math.max(this.width,this.height),n=((this.endTime||e)-(this.startTime||e))/1e3;return{distance:t,time:n,laps:this.laps,success:!this.collided&&this.laps>=3&&this.startTime>0,score:this.startTime>0?Math.max(0,t-n)+(this.laps+1)**2*10:0}}placeOnTrack(e){this.track=e,this.position.x=e.startingPoint.x,this.position.y=e.startingPoint.y,this.angle=e.startingAngle,this.speed=0,this.steering=0,this.acceleration=0,this.position.x-=e.startingDirection.x*this.width/2,this.position.y-=e.startingDirection.y*this.height/2;const t=this.net?Math.random()*e.roadThickness-e.roadThickness/2:0;this.position.x+=t*this.fudgeFactor*e.startingDirection.y,this.position.y-=t*this.fudgeFactor*e.startingDirection.x,this.odometer=0,this.laps=0,this.inCrossing=!1,this.startTime=0,this.endTime=0,this.collided=!1,this.fetchImageData();const n=Math.max(this.width,this.height,this.track.roadThickness)+1;this.pastTracking=[{x:e.startingPoint.x-e.startingDirection.x*n,y:e.startingPoint.y-e.startingDirection.y*n}],this.sensorsReady=!0,this.sensorReadingTime=Date.now()}endRun(e=!0){var r;const t=m.singleton;if(this.endTime=Date.now(),this.startTime||(this.startTime=this.endTime),this.inCrossing=!1,this.collided=e,this.fetchImageData(),!this.track||!this.net||this.score.score<=0)return;const n=Math.max(...Object.values(t.sotaScore).map(a=>a?a.score:0));this.score.score>(n??0)?(t.sotaNet=this.net.config,t.sotaScore={[this.track.name]:this.score},p.log(this.name,"set a new all-time highscore")):this.score.score>(((r=t.sotaScore[this.track.name])==null?void 0:r.score)??0)&&(p.log(this.name,"set a new highscore on track",this.track.name),t.sotaScore={[this.track.name]:this.score})}render(e,t=!1){if(this.canvas){if(e.save(),e.resetTransform(),e.translate(~~this.position.x,~~this.position.y),e.rotate(this.angle),(this.visualizeSensors||this.name==="Manual")&&M.registry.get().forEach((n,r)=>n.render(e,this.sensorReadings[r])),e.drawImage(this.canvas,~~(-this.width/2),~~(-this.height/2)),t){const n=Math.abs(Math.sin(Date.now()/200)+1);e.filter=`blur(${n*5}px) brightness(${n*100}%)`,e.drawImage(this.canvas,~~(-this.width/2),~~(-this.height/2))}e.restore()}}tick(e){if(this.collided||!this.track)return;if(this.name==="Manual")this.manualControl();else{const a=this.score;if(a.score<-10||this.totalTicks>3&&a.score<=0)return p.log(this.name,"doesn't seem to be going anywhere"),this.endRun();if(this.totalTicks>3&&a.score<=a.time/2)return p.log(this.name,"seems to be going too slow"),this.endRun();if(a.laps>=3)return this.endRun()}const t=m.singleton;if(this.totalTicks+=e,this.steering=$(this.steering,-1,1),this.steering=$(this.steering,-this.speed,this.speed),Math.abs(this.steering)>=.01&&(this.angle+=t.maxSteering*this.steering*e,this.steering-=t.friction*Math.sign(this.steering)*e,this.speed-=t.friction*this.speed*e),this.angle>Math.PI?this.angle-=Math.PI*2:this.angle<-Math.PI&&(this.angle+=Math.PI*2),this.acceleration=$(this.acceleration,-1,1),Math.abs(this.acceleration)>=.01?(this.speed+=t.maxAcceleration*this.acceleration*e,this.acceleration-=t.friction*Math.sign(this.acceleration)*e):this.speed-=t.friction*this.speed*e,this.speed=$(this.speed,0,t.maxSpeed),this.position.x+=Math.cos(this.angle)*this.speed*e,this.position.y+=Math.sin(this.angle)*this.speed*e,this.odometer+=this.speed*e,this.position.x<=0||this.position.x>=this.track.width||this.position.y<=0||this.position.y>=this.track.height)return p.log(this.name,"went out of bounds"),this.endRun();const n=Math.max(this.width,this.height,this.track.roadThickness),r=this.pastTracking.map(a=>Math.hypot(a.x-this.position.x,a.y-this.position.y));if(r.length===0||r.every(a=>a>n))this.pastTracking.unshift({x:this.position.x,y:this.position.y}),this.pastTracking.length>3&&this.pastTracking.pop();else if(r.length>1&&r.slice(1).some(a=>a<n))return p.log(this.name,"went back on the track"),this.endRun();this.checkSensors()}async renderSensors(){var e;return K([],{width:m.singleton.trackWidth,height:m.singleton.trackHeight,sources:[{src:((e=this.track)==null?void 0:e.mask)||"transparent",smoothing:!1},{src:this.mask,position:{x:this.position.x-this.width/2,y:this.position.y-this.height/2},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1},...M.registry.get().map(t=>({src:t.mask,position:{x:this.position.x-t.range,y:this.position.y-t.range},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1}))]})}checkSensors(){if(!(!this.track||this.collided)&&!(!this.sensorsReady&&Date.now()-this.sensorReadingTime<100))return this.sensorsReady=!1,K([],{width:this.track.width,height:this.track.height,reuse:this.sensorImage,clear:!0,sources:[{src:this.track.mask,smoothing:!1},{src:this.mask,position:{x:this.position.x-this.width/2,y:this.position.y-this.height/2},rotate:this.angle*(180/Math.PI),composition:"lighter",smoothing:!1}]}).then(e=>{if(this.sensorImage=e,this.checkCollision(e))return this.endRun();if(this.sensorReadings=M.readAll(e,this.position.x,this.position.y,this.angle),this.net){const n=this.net.eval([...this.sensorReadings,this.acceleration,this.steering,this.speed/m.singleton.maxSpeed,this.angle/Math.PI]);this.acceleration=n[0],this.steering=n[1]}}).catch(e=>{console.error("Error reading sensors",this.name,e)}).finally(()=>{this.sensorsReady=!0,this.sensorReadingTime=Date.now()})}checkCollision(e){const t=~~Math.max(this.width/2,this.height/2)+1,n=e.getPixels(this.position.x-t,this.position.y-t,t*2,t*2).buffer,r=n.some(l=>M.check(l,M.vehicle,M.lapLine)),a=n.some(l=>M.check(l,M.vehicle,M.offTrack)),o=this.angle,h=this.track.startingAngle;let d=Math.abs((o<0?o+Math.PI*2:o)-(h<0?h+Math.PI*2:h));if(d>Math.PI&&(d=Math.PI*2-d),r&&!this.inCrossing){if(this.inCrossing=!0,d>Math.PI/2)return p.log(this.name,"crossed the lap line the wrong way"),!0;if(!this.startTime)this.startTime=Date.now();else{if(this.odometer<this.width+this.height+this.track.roadThickness)return p.log(this.name,"didn't complete a full lap"),!0;this.laps++,p.log(this.name,"has completed lap",this.laps,"with score",~~this.score.score)}}else if(!r&&this.inCrossing&&(this.inCrossing=!1,d>Math.PI/2))return p.log(this.name,"turned around on the lap line"),!0;return a?(p.log(this.name,"went off track"),!0):!1}manualControl(){C.some("ArrowDown","S")?this.acceleration=$(this.acceleration-.1,-1,-.1):C.some("ArrowUp","W")?this.acceleration=$(this.acceleration+.1,.1,1):this.acceleration=0,C.some("ArrowLeft","A")?this.steering=$(this.steering-.1,-1,-.1):C.some("ArrowRight","D")?this.steering=$(this.steering+.1,.1,1):this.steering=0}static renderAll(e){Object.values(p.registry.get()).sort((n,r)=>r.score.score-n.score.score).forEach((n,r)=>n.render(e,r===0))}static tickAll(e){var t;if(Object.values(p.registry.get()).forEach(n=>n.tick(e)),m.singleton.autoAdvance){const n=Object.values(p.registry.get()),r=Date.now()-1e3;if(n.every(a=>a.collided&&a.laps<3&&a.endTime<r)){const a=(t=n[0])==null?void 0:t.track;a&&p.nextGeneration(a,!1)}}}static async nextGeneration(e,t=!1){var y,v,S,I,z,W,H;const n=m.singleton,r=p.registry.get();n.manualControl&&(!r.Manual||(((y=r.Manual)==null?void 0:y.collided)??!0)||(((S=(v=r.Manual)==null?void 0:v.track)==null?void 0:S.name)??"")!==e.name)?new p("Manual","#33eeee").placeOnTrack(e):!n.manualControl&&r.Manual&&delete r.Manual;const a=Object.values(r).filter(x=>x.name!=="Manual"&&x.net);if(!t&&a.some(x=>!x.collided&&x.track===e))return;a.forEach(x=>x.endRun()),a.sort((x,L)=>L.score.score-x.score.score);const o=new X(n.sotaNet),h=n.sotaScore[e.name],d=((I=a[0])==null?void 0:I.net)??o,l=((z=a[0])==null?void 0:z.score)??h,g=Math.floor(Math.random()*a.length),f=((W=a[g])==null?void 0:W.net)??d,w=((H=a[g])==null?void 0:H.score)??l;for(let x=0;x<n.numSimulations.globalBest;x++){const L=new p(`AI.globalBest.${x}`);L.net=o.randomStep(x===0?0:le(h))}for(let x=0;x<n.numSimulations.trackBest;x++){const L=new p(`AI.trackBest.${x}`);L.net=d.randomStep(x===0&&(l==null?void 0:l.score)!==(h==null?void 0:h.score)?0:le(l))}for(let x=0;x<n.numSimulations.trackRandom;x++){const L=new p(`AI.trackRandom.${x}`);L.net=f.randomStep(le(w))}n.numIterations++,p.log("Starting iteration",n.numIterations),Object.values(r).forEach(x=>{x.track||x.placeOnTrack(e)}),await Promise.all(Object.values(r).map(x=>x.fetchImageData())),m.save(),p.registry.signal()}static log(...e){const t=e.map(n=>n?typeof n=="string"?n:typeof n=="number"?String(~~n):Ce(n):null).filter(n=>!!n).join(" ");for(console.log(t),p.events.push(t);p.events.length>10;)p.events.shift()}};c(p,"registry",_({})),c(p,"events",[]);let N=p;function le(s){return!s||!s.score||!s.distance||!s.time?1:$(Math.sqrt(10/s.score),.1,1)}const k=class k{constructor(e){c(this,"ticksPerSec",100);c(this,"rendersPerSec",30);c(this,"saveFrequencySecs",10);c(this,"minUpdateSecs",.01);c(this,"maxUpdateSecs",.25);c(this,"maxTickSecs",.1);c(this,"globalTimeDilation",1);c(this,"globalPaused",!1);c(this,"lastReset",Date.now());c(this,"lastSaved",0);c(this,"lastLoaded",Date.now());c(this,"lastRender",0);c(this,"lastTick");c(this,"onTickComplete");c(this,"execution",{});c(this,"helpDismissed");c(this,"trackWidth",800);c(this,"trackHeight",600);c(this,"currentTrack","Basic");c(this,"autoAdvance",!1);c(this,"carWidth",20);c(this,"carHeight",15);c(this,"friction",.1);c(this,"maxSpeed",100);c(this,"maxAcceleration",25);c(this,"maxSteering",Math.PI/2);c(this,"manualControl",!1);c(this,"renderSensors",!1);c(this,"sensors",[{range:100,angle:0},{range:100,angle:Math.PI/6},{range:100,angle:-Math.PI/6},{range:100,angle:Math.PI/3},{range:100,angle:-Math.PI/3}]);c(this,"numIterations",0);c(this,"numSimulations",{globalBest:4,trackBest:4,trackRandom:2});c(this,"sotaScore",{});c(this,"sotaNet",X.init(this.sensors.length+4,2,[]).config);c(this,"timer",null);k.singleton=this,this.load(e)}static isDebug(){return window.location.href.toLowerCase().includes("debug")}static useHook(){return k.registry.useHook()}static set(e){return k.singleton.set(e)}static tick(e,t){return k.singleton.tick(e,t,k.save,k.registry.signal)}static async save(){k.singleton.tick(void 0,"save");const e=await R.write("Settings",k.singleton.save());return k.registry.signal(),e}static async load(){return k.singleton.load(await R.read("Settings")),k.singleton.tick(void 0,"load"),k.registry.signal(),k.singleton}static reset(e){return k.singleton=new k(e),k.registry.signal(),k.singleton}static addTickTimer(){k.removeTickTimer();const e=setInterval(()=>k.tick(void 0,"tick"),1e3/k.singleton.ticksPerSec);k.singleton.timer=e}static removeTickTimer(){k.singleton.timer&&clearInterval(k.singleton.timer),k.singleton.timer=null}set(e){let t;for(t in e)e[t]==null||e[t]==null||(typeof this[t]=="object"&&typeof e[t]=="object"?Object.assign(this[t],e[t]):this[t]=e[t]);return k.registry.signal(),this}load(e){if(e){if(typeof e=="string")return this.load(JSON.parse(e))}else return this;return this.set(e),this.lastLoaded=Date.now(),this}save(){return this.lastSaved=Date.now(),this}tick(e=Date.now(),t="unknown",n,r){var f,w;const a=this.lastTick??e;let o=$((e-a)/1e3,0,this.maxUpdateSecs);if(o<this.minUpdateSecs&&this.lastTick!=null)return[];this.lastTick=e;const h=e-o*1e3,d={},l=1/this.globalTimeDilation,g=[o,1];for(;o>0;){const y=$(o,this.minUpdateSecs,this.maxTickSecs);o-=y,t==="tick"&&N.tickAll(this.globalPaused?0:y*l)}return this.execution[t]={lastTick:e,lastDelta:(e-h)/1e3,lastResult:Object.values(d).flat().filter((y,v,S)=>S.indexOf(y)===v),tps:(((f=this.execution[t])==null?void 0:f.tps)||0)*.8+g[1]/g[0]*.2,fps:((w=this.execution[t])==null?void 0:w.fps)||0},this.onTickComplete&&this.onTickComplete((e-h)/1e3,t),n&&this.lastTick-this.lastSaved>=this.saveFrequencySecs*1e3&&this.lastTick-this.lastLoaded>=this.saveFrequencySecs*1e3&&(this.lastSaved=this.lastTick,n(this)),r&&this.lastTick-this.lastRender>=1e3/this.rendersPerSec&&(this.execution[t].fps=(this.execution[t].fps||0)*.8+1e3/(this.lastTick-this.lastRender)*.2,this.lastRender=this.lastTick,r(this)),this.execution[t].lastResult}};c(k,"singleton",new k),c(k,"registry",_(()=>k.singleton));let m=k;const j=class j{constructor(e,t){c(this,"renderImage");c(this,"path");this.range=e,this.angle=t;const n=e*Math.cos(t),r=e*Math.sin(t);this.path=`M ${~~e} ${~~e} l ${~~n} ${~~r}`}static useHook(){return j.registry.useHook()}get maskColor(){return j.radar}get mask(){return[`<svg
        width="${this.range*2}px"
        height="${this.range*2}px"
        viewBox="0 0 ${this.range*2} ${this.range*2}"
      >`,`<path
        d="${this.path}"
        stroke="${j.color.radar}"
        stroke-width="2px"
        stroke-linecap="butt"
        fill="none"
        shape-rendering="crispEdges"
      />`,"</svg>"].join("")}get image(){return[`<svg
        width="${this.range*2}px"
        height="${this.range*2}px"
        viewBox="0 0 ${this.range*2} ${this.range*2}"
      >`,`<path
        d="${this.path}"
        stroke="green"
        stroke-width="2px"
        stroke-linecap="round"
        fill="none"
      />`,"</svg>"].join("")}get canvas(){var e;return(e=this.renderImage)==null?void 0:e.canvas}async fetchImageData(){return this.renderImage=await K([this.image],{reuse:this.renderImage,clear:!0,width:this.range*2,height:this.range*2}),this.renderImage}render(e,t=1){if(!this.canvas)return;const n=~~this.range,r=~~(this.range*t);e.globalCompositeOperation="lighter",e.drawImage(this.canvas,-n,-n,n*2,n*2),e.globalCompositeOperation="source-over",e.drawImage(this.canvas,-r,-r,r*2,r*2)}read(e,t,n,r,a,o){const h=Math.cos(this.angle+o),d=Math.sin(this.angle+o);let l=0;for(let g=0;g<this.range;g++){const f=$(~~(a+g*d),0,n-1),w=$(~~(r+g*h),0,t-1);if(j.check(e[f*t+w],j.offTrack))break;l=g}return $(l/this.range,0,1)}static check(e,...t){const n=xt(t.reduce((r,a)=>r|a,0));return(e&n)===n}static async loadAll(){const e=m.singleton.sensors.map(({range:t,angle:n})=>new j(t,n));e.forEach(t=>j.registry.get().push(t)),await Promise.all(e.map(t=>t.fetchImageData())),j.registry.signal()}static readAll(e,t,n,r){const a=~~Math.max(...j.registry.get().map(f=>f.range)),{buffer:o,startX:h,startY:d,width:l,height:g}=e.getPixels(~~t-a,~~n-a,a*2,a*2);return j.registry.get().map(f=>f.read(o,l,g,a-h,a-d,r))}};c(j,"registry",_([])),c(j,"available",0),c(j,"offTrack",8388608),c(j,"lapLine",32768),c(j,"vehicle",8355711),c(j,"radar",128),c(j,"color",{available:Y(j.available),offTrack:Y(j.offTrack),lapLine:Y(j.lapLine),vehicle:Y(j.vehicle),radar:Y(j.radar)});let M=j;function Y(s){return"#"+s.toString(16).padStart(6,"0")}function xt(s){return(s&16711680)>>16|(s&255)<<16|s&65280}const J=class J{constructor(e){c(this,"renderImage");c(this,"width",m.singleton.trackWidth);c(this,"height",m.singleton.trackHeight);this.name=e}get startingAngle(){return Math.atan2(this.startingDirection.y,this.startingDirection.x)}get mask(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        fill="${M.color.offTrack}"
        shape-rendering="crispEdges"
      />`,this.path.map(e=>`<path
            d="${e}"
            stroke="${M.color.available}"
            stroke-width="${this.roadThickness}px"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
            shape-rendering="crispEdges"
          />`),`<path
        d="M ${this.startingPoint.x} ${this.startingPoint.y} l ${Math.sign(this.startingDirection.x)*this.laneMarkingThickness} ${Math.sign(this.startingDirection.y)*this.laneMarkingThickness}"
        stroke="${M.color.lapLine}"
        stroke-width="${this.roadThickness}px"
        stroke-linecap="butt"
        fill="none"
      />`,"</svg>"].join("")}get image(){return[`<svg
        width="${this.width}px"
        height="${this.height}px"
        viewBox="0 0 ${this.width} ${this.height}"
      >`,`<rect
        width="${this.width}"
        height="${this.height}"
        fill="lightgreen"
      />`,this.path.map(e=>`<path
            d="${e}"
            stroke="salmon"
            stroke-width="${this.roadThickness+this.laneMarkingThickness*2}px"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />`),this.path.map(e=>`<path
            d="${e}"
            stroke="lightgray"
            stroke-width="${this.roadThickness}px"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />`),this.path.map(e=>`<path
            d="${e}"
            stroke="yellow"
            stroke-width="${this.laneMarkingThickness}px"
            stroke-dasharray="
              ${this.laneMarkingThickness*3},
              ${this.laneMarkingThickness*5}"
            stroke-dashoffset="${this.laneMarkingThickness}"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />`),`<path
        d="M ${this.startingPoint.x} ${this.startingPoint.y} l ${Math.sign(this.startingDirection.x)*this.laneMarkingThickness} ${Math.sign(this.startingDirection.y)*this.laneMarkingThickness}"
        stroke="white"
        stroke-width="${this.roadThickness}px"
        stroke-linecap="butt"
        fill="none"
      />`,"</svg>"].join("")}get canvas(){var e;return(e=this.renderImage)==null?void 0:e.canvas}async fetchImageData(){return this.renderImage=await K([this.image],{reuse:this.renderImage,clear:!0,width:this.width,height:this.height}),this.renderImage}render(e){this.canvas&&e.drawImage(this.canvas,0,0)}static async loadAll(){const e=[new pt("Basic"),new kt("Advanced"),new wt("Oval"),new yt("Curvy")];e.forEach(t=>{J.registry.get()[t.name]=t}),await Promise.all(e.map(t=>t.fetchImageData())),J.registry.signal()}static useHook(){return J.registry.useHook()}};c(J,"registry",_({}));let B=J;class pt extends B{get path(){return["M 730 70 h -360 v 200 h -300 v 260 h 400 l 260 -260 v -160 Z"]}get roadThickness(){return 80}get laneMarkingThickness(){return 3}get startingPoint(){return{x:150,y:530}}get startingDirection(){return{x:1,y:0}}}class kt extends B{get path(){return["M 750 50 h -300 l -200 100 l -100 -70 h -100 v 450 h 300 v -150 h 50 v -200 h 100 v 380 h 150 Z"]}get roadThickness(){return 60}get laneMarkingThickness(){return 3}get startingPoint(){return{x:600,y:50}}get startingDirection(){return{x:1,y:0}}}class wt extends B{get path(){return["M 400 100 Q 100 100 100 300 T 400 500 T 700 300 T 400 100 Z"]}get roadThickness(){return 100}get laneMarkingThickness(){return 3}get startingPoint(){return{x:400,y:100}}get startingDirection(){return{x:-1,y:0}}}class yt extends B{get path(){return["M 100 300 c 0 100 50 200 150 200 s 50 -150 150 -150 s 50 150 150 150 s 150 -100 150 -200 s 0 -100 -100 -100 s -100 0 -100 -100 s 0 0 -100 0 s 0 0 -100 0 s 0 -50 -100 -50 s -100 150 -100 250 Z"]}get roadThickness(){return 70}get laneMarkingThickness(){return 3}get startingPoint(){return{x:400,y:100}}get startingDirection(){return{x:-1,y:0}}}const jt=He,vt=Fe,bt=Be,Se=nt;function It({icon:s,src:e,...t}){const n=s||e||"";return n.startsWith("data:")?i.jsx(F,{icon:n,...t}):n.includes("/")||n.includes(".")?i.jsx(F,{src:n,...t}):Se[n]?i.jsx(F,{icon:Se[n],...t}):i.jsx(F,{icon:rt,...t})}function U(){const s=U.useTabs(),e=window.location.search||"";return i.jsx(Ue,{children:i.jsxs(vt,{children:[i.jsxs(We,{children:[s.map(t=>i.jsx(ve,{exact:!0,path:`/${t.path}`,children:i.jsxs(qe,{children:[i.jsx(Ge,{children:i.jsxs(Je,{children:[i.jsx(Ye,{slot:"start",children:t.title||t.path}),i.jsxs(be,{slot:"end",color:"success",children:["© 2025  ",i.jsx("a",{href:"https://github.com/lepouya",target:"_blank",style:{textDecoration:"none"},children:"@lepouya"})]}),i.jsx(be,{slot:"end",color:"light",children:i.jsx("a",{href:"https://github.com/lepouya/idle-self-driving",target:"_blank",style:{textDecoration:"none"},children:i.jsx("small",{children:"view source"})})})]})}),i.jsx(Me,{id:"tab-contents",children:t.content}),s.filter(n=>n.alwaysMounted&&n!==t).map(n=>i.jsx(b.Fragment,{children:n.content},`page-${n.path}`))]})},`tab-${t.path}`)),s.filter(t=>!!t.from).map(t=>i.jsx(ve,{exact:!0,path:t.from,children:i.jsx(Ke,{to:`/${t.path}${e}`})},`default-tab-${t.path}`))]}),i.jsx(Ze,{slot:"bottom",children:s.map(t=>(t.icon||t.label)&&i.jsxs(bt,{tab:t.path,href:`/${t.path}${e}`,children:[t.icon&&i.jsx(It,{"aria-hidden":"true",icon:t.icon}),t.label&&i.jsx(D,{children:t.label})]},`tab-button-${t.path}`))})]})})}const V=_({});U.register=function(s){V.get()[s.path]=s,V.signal()};U.unregister=function(s){delete V.get()[typeof s=="string"?s:s.path],V.signal()};U.useTabs=function(){const s=V.useHook();return Object.values(s)};function P(s,e){return s==null||s==null||typeof s=="string"?P.word(s??void 0,e):s instanceof Date?P.time(s.getTime(),e):typeof s=="number"?P.number(s,e):""}P.number=function(s,e){const t=(Math.log10(Math.abs(s))<3?e==null?void 0:e.smallPrec:e==null?void 0:e.prec)??(e==null?void 0:e.prec)??0;let n=isFinite(s)?s.toFixed(t):s.toString();return n&&(e!=null&&e.alwaysShowSign)&&!"+-".includes(n[0])&&s>=0&&(n="+"+n),n};P.time=function(s,e){const t=(e==null?void 0:e.len)??"long",n=(e==null?void 0:e.sep)??t==="long"?", ":":",r=(e!=null&&e.oxfordComma?n:"")+((e==null?void 0:e.lastSep)??t==="long"?" and ":n),a=(e==null?void 0:e.now)??t==="long"?"now":"",o=(e==null?void 0:e.never)??t==="long"?"never":"",h=(e==null?void 0:e.ago)??t==="long"?"ago":"";if(o&&(s<0||(e==null?void 0:e.epoch)!=null&&(e.epoch<=0||s-e.epoch<0)))return o;if(a&&(s===0||(e==null?void 0:e.epoch)!=null&&s===e.epoch))return a;(e==null?void 0:e.epoch)!=null&&(s-=e.epoch);let d=Math.floor(s/1e3),l=Math.floor(s-d*1e3),g=Math.floor(d/60);d-=g*60;let f=Math.floor(g/60);g-=f*60;let w=Math.floor(f/24);f-=w*24;let y=Math.floor(w/365);if(w-=y*365,e!=null&&e.millis||(l=0),a!=null&&w+f+g+d+l===0)return a;let v=[];if(t!=="long"?v=[y>0?y.toFixed(0):"",w>0?w.toFixed(0):"",f>0||t==="short"?f.toFixed(0):"",g>0||t==="short"?g.toFixed(0):"",(d+l/1e3).toFixed(!(e!=null&&e.millis)||t==="tiny"&&l===0?0:3)].map(I=>t==="short"&&(I.length===1||I.indexOf(".")===1)?"0"+I:I):v=[[y,"year"],[w,"day"],[f,"hour"],[g,"minute"],[d,"second",y+w+f+g===0,l]].map(([I,z,W=!1,H=0])=>I>0||H>0||W&&I===0?I.toString()+(H>0?"."+H.toString():"")+" "+z+(I===1?"":"s"):""),v=v.filter(I=>!!I),v.length>2){const I=v.pop();v=[v.join(n),I]}let S=v.join(r)+(h?" "+h:"");return S&&(e!=null&&e.alwaysShowSign)&&s>=0&&t!=="long"&&!"+-".includes(S[0])&&(S="+"+S),S};P.word=function(s,e){return s||(s=(Math.abs(Math.abs((e==null?void 0:e.count)??0)-1)<=((e==null?void 0:e.tolerance)??.001)?e==null?void 0:e.singularName:e==null?void 0:e.pluralName)??(e==null?void 0:e.name)),(e==null?void 0:e.condition)??!0?!s&&!((e==null?void 0:e.allowEmpties)??!1)?"":(e==null?void 0:e.capitalize)??!0?(s??"").replace(/([a-z])([A-Z]|_\S)/g,(t,n,r)=>`${n} ${r.slice(-1)}`).replace(/(?:^|\s)\w(?=\w)/g,t=>t.toUpperCase()):s??"":""};function he(){var h,d,l;const s=m.useHook(),e=b.useRef(null),t=B.useHook(),n=N.useHook(),r=t[s.currentTrack];b.useEffect(()=>{N.nextGeneration(r,!1)},[r]),b.useEffect(()=>{var g;if(e.current){const f=e.current.getContext("2d",{alpha:!1});s.renderSensors?(g=n[0])==null||g.renderSensors().then(w=>{f.clearRect(0,0,s.trackWidth,s.trackHeight),f.resetTransform(),f.drawImage(w.canvas,0,0)}):(r.render(f),N.renderAll(f))}},[s.currentTrack,e.current,s.lastRender]);const a=Math.max(...n.map(g=>g.score.score))||0,o=n.filter(g=>!g.collided).length;return i.jsxs(fe,{children:[i.jsxs(T,{children:[i.jsx(u,{size:"8",children:i.jsx("canvas",{ref:e,width:`${s.trackWidth}px`,height:`${s.trackHeight}px`})}),i.jsxs(u,{size:"4",children:[i.jsxs(E,{children:[i.jsxs(D,{children:["Iteration ",s.numIterations]}),i.jsx(O,{slot:"end",expand:"block",title:"Skip to next iteration",onClick:()=>N.nextGeneration(r,!0),children:i.jsx(F,{icon:$e})}),i.jsx(O,{slot:"end",expand:"block",color:s.autoAdvance?"primary":"medium",title:"Toggle auto-advance at the end of each iteration",onClick:()=>s.set({autoAdvance:!s.autoAdvance}),children:i.jsx(F,{icon:Ae})}),i.jsx(O,{slot:"end",expand:"block",color:s.globalPaused?"medium":"primary",title:s.globalPaused?"Resume":"Pause",onClick:()=>s.set({globalPaused:!s.globalPaused}),children:i.jsx(F,{icon:s.globalPaused?at:ot})})]}),i.jsxs(E,{children:[i.jsx(D,{children:"Leader Score"}),i.jsx(D,{slot:"end",children:P(a,{prec:2})})]}),i.jsxs(E,{children:[i.jsx(D,{children:"Active Cars"}),i.jsxs(D,{slot:"end",children:[o,"/",n.length]})]}),i.jsx(E,{children:i.jsx(D,{children:" "})}),i.jsx(E,{children:i.jsx(Qe,{label:"Track Selection",interface:"alert",value:s.currentTrack,onIonChange:g=>{s.set({currentTrack:g.detail.value})},children:Object.keys(t).map(g=>i.jsx(Xe,{value:g,children:g},g))})}),i.jsxs(E,{children:[i.jsxs(D,{children:["Best Score on ",s.currentTrack," Track"]}),i.jsx(D,{slot:"end",children:P(Math.max(a,((h=s.sotaScore[s.currentTrack])==null?void 0:h.score)||0),{prec:2})})]}),i.jsx(E,{children:i.jsx(D,{children:" "})}),i.jsxs(E,{children:[i.jsx(D,{children:"Simulation Speed"}),i.jsxs(D,{slot:"end",children:[P(((d=s.execution.tick)==null?void 0:d.tps)||0)," tps"]})]}),i.jsxs(E,{children:[i.jsx(D,{children:"Rendering Speed"}),i.jsxs(D,{slot:"end",children:[P(((l=s.execution.tick)==null?void 0:l.fps)||0)," fps"]})]}),i.jsx(E,{children:i.jsx(Ie,{checked:s.manualControl,onIonChange:g=>{s.set({manualControl:g.detail.checked}),N.nextGeneration(r,!1)},children:"Manually Controlled Car"})}),i.jsx(E,{children:i.jsx(Ie,{checked:!s.helpDismissed,onIonChange:g=>{s.set({helpDismissed:!g.detail.checked})},children:"Show Help/About Page"})})]})]}),i.jsx(T,{children:i.jsx(u,{size:"12",children:i.jsx(me,{label:"Driving events",labelPlacement:"floating",fill:"outline",placeholder:"Car Events are logged here",rows:10,value:N.events.join(`
`),readonly:!0})})})]})}he.init=()=>{U.register({path:"driving",content:i.jsx(he,{}),icon:"speedometerOutline",label:"Driving",title:"Idle Self Driving",from:"/"})};function de(){const s=m.useHook();return s.helpDismissed?null:i.jsx(Ve,{trigger:"tab-contents",isOpen:!s.helpDismissed,showBackdrop:!0,side:"start",alignment:"start",onDidDismiss:()=>s.set({helpDismissed:!0}),children:i.jsx(Tt,{})})}function Tt(){const s=m.useHook(),e=b.useRef(null),[t,n]=b.useState(),[r,a]=b.useState();return b.useEffect(()=>{(async()=>{const h=new St("Demo Track"),d=new N("","#33eeee",0,!1);d.visualizeSensors=!0,await Promise.all([h.fetchImageData(),d.fetchImageData()]),d.placeOnTrack(h),d.position={x:100,y:100},d.tick(0),await d.renderSensors(),n(h),a(d)})()},[n,a]),b.useEffect(()=>{if(!e.current||!r||!r.canvas||!t||!t.canvas)return;const o=s.lastRender/1e3%8*45*(Math.PI/180);r.position={x:100+50*Math.cos(o),y:100+40*Math.sin(o)},r.angle=o+Math.PI/2,r.tick(0);const h=e.current.getContext("2d",{alpha:!1});t.render(h),r.render(h)},[s.lastRender,e.current,r,t]),i.jsxs(Me,{id:"help-page",class:"ion-padding",children:[i.jsxs(fe,{fixed:!0,children:[i.jsx(T,{children:i.jsx(u,{children:i.jsx("h1",{children:"About: Idle Self Driving"})})}),i.jsx(T,{children:i.jsx(u,{children:i.jsx("p",{children:"This is a simple demonstration of self-driving cars receiving sensory information from their surroundings and controlling their acceleration and steering using a simple neural network."})})}),i.jsxs(T,{children:[i.jsx(u,{size:"4",children:i.jsx("canvas",{ref:e,width:`${(t==null?void 0:t.width)||1}px`,height:`${(t==null?void 0:t.height)||1}px`,style:{margin:"auto",display:"block"}})}),i.jsxs(u,{size:"8",children:[i.jsx("p",{children:"Each car has 5 sensor inputs in front of it. The reading values are between 0 and 1 indicating how far the car is from the edges of the track"}),i.jsx("p",{children:"The network outputs two values between -1 and 1. One for the acceleration of the car (negative means breaking), and the other for steering (negative for left, positive for right)."}),i.jsx("p",{children:"A simple simulation calculates the velocity and the angle of the car. Some basic friction is also calculated for speed and steering, but I didn't bother with drifting or skidding. At least not for now."})]})]}),i.jsx(T,{children:i.jsxs(u,{children:[i.jsx("p",{children:'The cars can "lose" if they hit the edges of the track. There are also some criteria for crossing the finish line in wrong direction or backtracking on the track. There is no collision between the cars, so you can think of this as being in separate tracks or ghosting.'}),i.jsx("p",{children:'A car "wins" if it successfully laps the track 3 times. The scoring is based on the distance travelled and the speed of the car. The faster a car finishes the laps the better it scores. And the further it gets before losing the better it scores.'}),i.jsx("p",{children:"At the beginning of each iteration, 10 new cars are generated based on the global best on the track and the winner of the last track. Some random choices are also made. The further we are in the training, the less random variations there are between cars"}),i.jsxs("p",{children:["The ",i.jsx(F,{icon:$e})," button will start a new iteration, even if there are still cars racing in the current track. Use the ",i.jsx(F,{icon:Ae})," ","button to automatically advance to the next iteration after all cars have finished."]})]})}),i.jsx(T,{children:i.jsxs(u,{children:[i.jsx("p",{children:'You can also change the track the race is taking place on the right side panel. I recommend moving on to the "Advanced" track once you have trained a car that can lap around the "Basic" track. It might take a few more iterations before you have a car that can make the tight corners on the "Advanced" track.'}),i.jsx("p",{children:'There is also an "Oval" track that you can use for fine-tuning the speed of the track navigation, but be mindful that staying on it too long might cause your model to "forget" how to turn left. This is not a commentary on NASCAR™. I promise.'}),i.jsx("p",{children:'Finally, you can put all of the learnings to the test on the "Curvy" track to test both steering abilities and the speed choices of your model.'})]})}),i.jsx(T,{children:i.jsxs(u,{children:["Pro tips:",i.jsxs("ul",{children:[i.jsx("li",{children:'You can save / load / reset the state on the "Settings" tab below. Using import/export features lets you share your models'}),i.jsx("li",{children:"The ability to customize # of sensors, their angles, and ranges are there, but I haven't made the UI for it yet. You can still do it by mocking around in the saved settings, or just get the source code: the link is on top right. Coming later."}),i.jsx("li",{children:"Ability to change the # of layers and neurons in the net is also there, but doesn't have a UI either. You can use the same tricks above to play with it. Or to view your current SOTA."}),i.jsx("li",{children:'If you want your save files in plain text (json) instead of base64, add "?debug" to the end of the URL and you get a bunch of new feature'})]})]})})]}),i.jsx(O,{onClick:()=>s.set({helpDismissed:!0}),children:"Close"})]})}class St extends B{constructor(){super(...arguments);c(this,"width",200);c(this,"height",200)}get path(){return["M 0 100 h 200"]}get roadThickness(){return 120}get laneMarkingThickness(){return 3}get startingPoint(){return{x:25,y:100}}get startingDirection(){return{x:1,y:0}}}de.init=()=>{U.register({path:"help",content:i.jsx(de,{}),alwaysMounted:!0})};function ge(){return i.jsxs(fe,{children:[i.jsx(Mt,{}),i.jsx($t,{}),i.jsx(At,{}),i.jsx(Ct,{})]})}ge.init=()=>{U.register({path:"settings",content:i.jsx(ge,{}),icon:"settingsOutline",label:"Settings",title:"Settings"})};function Mt(){const s=m.useHook(),[e,t]=b.useState("");return i.jsxs(se,{children:[i.jsx(ie,{children:i.jsx(ne,{children:i.jsx(T,{children:i.jsx(u,{size:"12",className:"ion-text-center",children:i.jsx(Z,{children:"Data"})})})})}),i.jsxs(re,{children:[i.jsxs(T,{children:[i.jsxs(u,{size:"12",children:["Started"," ",P.time(s.lastTick??0,{epoch:s.lastReset})]}),i.jsxs(u,{size:"12",children:["This session started"," ",P.time(s.lastTick??0,{epoch:s.lastLoaded})]}),i.jsxs(u,{size:"12",children:["Last saved"," ",P.time(s.lastTick??0,{epoch:s.lastSaved})]})]}),i.jsxs(T,{children:[i.jsx(u,{size:"6",children:i.jsx(O,{onClick:()=>{m.load().then(()=>m.save()).then(te)},expand:"block",children:"Load"})}),i.jsx(u,{size:"6",children:i.jsx(O,{onClick:()=>m.save(),expand:"block",children:"Save"})}),i.jsx(u,{size:"6",children:i.jsx(O,{onClick:Dt,expand:"block",children:"Load from File"})}),i.jsx(u,{size:"6",children:i.jsx(O,{onClick:Pt,expand:"block",children:"Save to File"})}),i.jsx(u,{size:"6",children:i.jsx(O,{onClick:()=>{s.load(xe(e)),m.save().then(te)},expand:"block",children:"Import Text"})}),i.jsx(u,{size:"6",children:i.jsx(O,{onClick:()=>t(oe(s.save(),m.isDebug())),expand:"block",children:"Export Text"})}),i.jsx(u,{size:"12",children:i.jsx(me,{label:"Data for import/export",labelPlacement:"floating",fill:"outline",rows:5,autoGrow:!0,value:e,onIonInput:n=>t(n.detail.value??"")})})]})]})]})}function $t(){const s=m.useHook(),[e,t]=b.useState(s.ticksPerSec),[n,r]=b.useState(s.rendersPerSec),[a,o]=b.useState(s.saveFrequencySecs);return b.useEffect(()=>{t(s.ticksPerSec)},[s.ticksPerSec]),b.useEffect(()=>{r(s.rendersPerSec)},[s.rendersPerSec]),b.useEffect(()=>{o(s.saveFrequencySecs)},[s.saveFrequencySecs]),i.jsxs(se,{children:[i.jsx(ie,{children:i.jsx(ne,{children:i.jsx(T,{children:i.jsx(u,{size:"12",className:"ion-text-center",children:i.jsx(Z,{children:"Advanced Settings"})})})})}),i.jsxs(re,{children:[i.jsxs(T,{children:[i.jsx(u,{size:"12",children:"If you are having performance issues, increase the time between updates. Faster updating frequncies lead to better experience but might use a lot of CPU."}),i.jsx(u,{size:"6",className:"ion-text-right",children:"Updating frequency:"}),i.jsxs(u,{size:"6",className:"ion-text-center",children:[Math.floor(1e3/s.ticksPerSec),"ms"]}),i.jsx(u,{size:"6"}),i.jsx(u,{size:"6",children:i.jsx(ce,{min:6,max:200,step:1,pin:!0,pinFormatter:h=>`${Math.floor(1e3/h)}ms`,value:e,onIonInput:h=>t(h.detail.value),onIonChange:h=>{s.set({ticksPerSec:h.detail.value})},className:"ion-no-padding"})}),i.jsx(u,{size:"6",className:"ion-text-right",children:"Rendering frequency:"}),i.jsxs(u,{size:"6",className:"ion-text-center",children:[Math.floor(1e3/s.rendersPerSec),"ms"]}),i.jsx(u,{size:"6"}),i.jsx(u,{size:"6",children:i.jsx(ce,{min:1,max:60,step:1,pin:!0,pinFormatter:h=>`${Math.floor(1e3/h)}ms`,value:n,onIonInput:h=>r(h.detail.value),onIonChange:h=>{s.set({rendersPerSec:h.detail.value})},className:"ion-no-padding"})})]}),i.jsxs(T,{children:[i.jsx(u,{size:"12",children:"Change how often the session is saved in the background. More frequent saving leads to faster backups, but increases CPU and I/O usage"}),i.jsx(u,{size:"6",className:"ion-text-right",children:"Saving frequency:"}),i.jsx(u,{size:"6",className:"ion-text-center",children:P.time(1e3*s.saveFrequencySecs,{ago:""})}),i.jsx(u,{size:"6"}),i.jsx(u,{size:"6",children:i.jsx(ce,{min:1,max:60,step:1,pin:!0,pinFormatter:h=>P.time(1e3*(300/h),{ago:"",len:"tiny"}).replace(":","m:")+"s",value:300/a,onIonInput:h=>o(300/h.detail.value),onIonChange:h=>{s.set({saveFrequencySecs:300/h.detail.value})},className:"ion-no-padding"})})]})]})]})}function At(){const[s,e]=b.useState(!1);function t(){s&&(e(!1),m.reset(),R.clear().then(te))}return i.jsxs(se,{children:[i.jsx(ie,{children:i.jsx(ne,{children:i.jsx(T,{children:i.jsx(u,{size:"12",className:"ion-text-center",children:i.jsx(Z,{children:"Reset"})})})})}),i.jsx(re,{children:i.jsxs(T,{children:[i.jsx(u,{size:"12",children:i.jsx(Z,{color:"danger",children:"WARNING: this will completely reset your settings and delete all saved progress. Only use this if you want to restart from the beginning, or if something in the settings is so messed up that it is unusable."})}),i.jsx(u,{size:"12",children:i.jsx(_e,{justify:"end",checked:s,onIonChange:()=>e(n=>!n),children:"I understand what this means and still want to reset"})}),i.jsx(u,{size:"12",class:"ion-text-right",children:i.jsx(O,{onClick:t,disabled:!s,color:s?"danger":"medium",children:"Reset everything"})})]})})]})}function Ct(){const s=m.useHook();return m.isDebug()&&i.jsxs(se,{children:[i.jsx(ie,{children:i.jsx(ne,{children:i.jsx(T,{children:i.jsx(u,{size:"12",className:"ion-text-center",children:i.jsx(Z,{children:"Debug Context"})})})})}),i.jsx(re,{children:i.jsx(T,{children:i.jsx(u,{size:"12",children:i.jsx(me,{autoGrow:!0,readonly:!0,value:oe(s,!0)})})})})]})}function Pt(){const s=m.singleton,e="idle-self-driving".replace(/\W/g,"_"),t="0.9.1".replace(/\W/g,"_"),n=new Date().toISOString().replace(/\D/g," ").trim().replace(/\D/g,"-"),r=`${e}-v${t}-${n}`,a=oe(s.save(),m.isDebug()),o=new Blob([a],{type:"text/plain"}),h=URL.createObjectURL(o),d=document.createElement("a");d.href=h,d.download=r,d.click(),URL.revokeObjectURL(h)}function Dt(){const s=document.createElement("input");s.type="file",s.addEventListener("change",function(e){const t=e.target.files;if(!t||t.length===0||!t[0])return;const n=new FileReader;n.onload=function(r){var h;const a=(h=r.target)==null?void 0:h.result;if(!a||typeof a!="string")return;const o=m.singleton;o.load(xe(a)),o.tick(void 0,"load"),m.save().then(te)},n.readAsText(t[0])},!1),s.click()}function te(){et().push("#/"),window.location.reload()}function ue(){const s=m.useHook();return b.useEffect(()=>(C.addEventListeners(),R.initialize(),()=>C.removeEventListeners()),[]),b.useEffect(()=>(m.addTickTimer(),()=>m.removeTickTimer()),[s.ticksPerSec]),null}ue.initialize=async function(){await R.initialize(),await m.load(),await Promise.all([he.init(),ge.init(),de.init()]),await Promise.all([B.loadAll(),M.loadAll()])};tt();window.addEventListener("load",async()=>{const s=document.createElement("div");s.id="root",document.body.appendChild(s);const e=st.createRoot(s);await ue.initialize(),e.render(i.jsx(b.StrictMode,{children:i.jsxs(jt,{children:[i.jsx(ue,{}),i.jsx(U,{})]})}))},!1);
